<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Геймификация изучения английского языка</title>
        <!-- Offline mode: removed external icon/font links -->
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
                background-color: #f8fafc;
                color: #334155;
                line-height: 1.6;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            /* Card Styles */
            .card {
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                padding: 24px;
                margin-bottom: 24px;
                transition: all 0.3s ease;
            }

            .card:hover {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }

            .card-header {
                margin-bottom: 20px;
            }

            .card-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1e40af;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            /* Header */
            .main-header {
                background: linear-gradient(135deg, #1e40af, #3b82f6);
                color: white;
                text-align: center;
                border-radius: 20px;
                margin-bottom: 32px;
            }

            .main-header h1 {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 8px;
            }

            .main-header p {
                font-size: 1.1rem;
                opacity: 0.9;
            }

            /* Grid Layout */
            .grid {
                display: grid;
                gap: 24px;
            }

            .grid-cols-3 {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }

            .grid-cols-2 {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }

            /* Stats Cards */
            .stat-card {
                text-align: center;
                position: relative;
                overflow: hidden;
            }

            .stat-value {
                font-size: 3rem;
                font-weight: 700;
                color: #1e40af;
                margin: 16px 0 8px 0;
            }

            .stat-label {
                font-size: 0.875rem;
                color: #64748b;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .stat-icon {
                position: absolute;
                top: 20px;
                right: 20px;
                font-size: 1.5rem;
                color: #fbbf24;
            }

            /* Progress Bar */
            .progress-container {
                background: #e2e8f0;
                border-radius: 12px;
                height: 12px;
                overflow: hidden;
                margin: 16px 0;
                position: relative;
            }

            .progress-bar {
                background: linear-gradient(90deg, #1e40af, #3b82f6);
                height: 100%;
                border-radius: 12px;
                transition: width 0.8s ease;
                position: relative;
            }

            .progress-bar::after {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent
                );
                animation: shine 2s infinite;
            }

            /* Weekly threshold markers */
            .progress-marker {
                position: absolute;
                top: -6px;
                width: 2px;
                height: 24px;
                background: #cbd5e1; /* slate-300 */
            }
            .progress-marker.active { background: #059669; }
            .progress-marker .progress-label {
                position: absolute;
                top: -18px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.7rem;
                color: #64748b;
                white-space: nowrap;
                font-weight: 600;
            }
            .progress-marker.active .progress-label { color: #059669; }
            .progress-marker.right .progress-label { left: 0; transform: translateX(-100%); }

            @keyframes shine {
                0% {
                    left: -100%;
                }
                100% {
                    left: 100%;
                }
            }

            /* Weekly Goals */
            .stars-container {
                display: flex;
                gap: 8px;
                margin: 16px 0;
                justify-content: center;
            }

            .star {
                font-size: 2rem;
                color: #e2e8f0;
                transition: all 0.3s ease;
            }

            .star.filled {
                color: #fbbf24;
                animation: sparkle 0.6s ease;
            }

            @keyframes sparkle {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.2);
                }
            }

            /* Redeem Stars */
            .redeem-stars-container { display:flex; gap: 12px; align-items:center; }
            .redeem-star { font-size: 1.75rem; color: #e5e7eb; transition: transform 0.2s ease, color 0.2s ease; }
            .redeem-star.filled { color: #f59e0b; transform: scale(1.05); }
            .redeem-star.ready { color: #059669; }





            /* Offline Icon Replacements (emoji-based) */
            .fa, .fas { display: inline-block; width: 1em; height: 1em; line-height: 1em; text-align: center; font-style: normal; }
            .fa::before, .fas::before { display: inline-block; }
            .fa-cog::before { content: "⚙️"; }
            .fa-chart-line::before { content: "📈"; }
            .fa-trophy::before { content: "🏆"; }
            .fa-star::before { content: "⭐"; }
            .fa-fire::before { content: "🔥"; }
            .fa-tasks::before { content: "📋"; }
            .fa-plus::before { content: "➕"; }
            .fa-medal::before { content: "🏅"; }
            .fa-lightbulb::before { content: "💡"; }
            .fa-gift::before { content: "🎁"; }
            .fa-calendar-alt::before { content: "📅"; }
            .fa-chevron-left::before { content: "◀"; }
            .fa-chevron-right::before { content: "▶"; }
            .fa-check-circle::before { content: "✅"; }
            .fa-sparkles::before { content: "✨"; }
            .fa-book::before { content: "📖"; }
            .fa-pencil-alt::before { content: "✏️"; }
            .fa-headphones::before { content: "🎧"; }
            .fa-trash::before { content: "🗑️"; }
            .fa-times::before { content: "✖"; }
            .fa-level-up-alt::before { content: "⬆️"; }
            .fa-chart-area::before { content: "📊"; }
            .fa-calendar-check::before { content: "🗓️"; }
            .fa-chart-bar::before { content: "📊"; }
            .fa-chart-pie::before { content: "🥧"; }
            .fa-clock::before { content: "⏰"; }
            .fa-trending-up::before { content: "📈"; }
            .fa-history::before { content: "🕘"; }
            .fa-crystal-ball::before { content: "🔮"; }
            .fa-crown::before { content: "👑"; }
            .fa-arrows-rotate::before { content: "🔄"; }
            .fa-download::before { content: "⬇️"; }
            .fa-upload::before { content: "⬆️"; }
            .fa-pen-to-square::before { content: "📝"; }
            .fa-microphone::before { content: "🎤"; }
            .fa-eye::before { content: "👁️"; }
            .fa-brain::before { content: "🧠"; }
            .fa-graduation-cap::before { content: "🎓"; }
            .fa-chalkboard-teacher::before { content: "👨‍🏫"; }
            .fa-language::before { content: "🌐"; }
            .fa-spell-check::before { content: "✅"; }
            .fa-target::before { content: "🎯"; }
            .fa-gamepad::before { content: "🎮"; }
            .fa-user-shield::before { content: "🛡️"; }
            .fa-share-alt::before { content: "📤"; }
            .fa-google-drive::before { content: "☁️"; }
            .fa-database::before { content: "🗄️"; }
            .fa-folder-open::before { content: "📂"; }

            /* Tasks */
            .task-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .task-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 16px;
                background: #f8fafc;
                border-radius: 12px;
                border: 1px solid #e2e8f0;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .task-item:hover {
                background: #f1f5f9;
                border-color: #1e40af;
                transform: translateY(-2px);
            }

            .task-info {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .task-icon {
                width: 40px;
                height: 40px;
                background: #1e40af;
                color: white;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
            }

            .task-icon i {
                width: 1.25em; /* normalize FA icon width */
                text-align: center;
                line-height: 1;
                font-size: 1.1rem; /* ensure consistent icon size */
            }

            /* Icon selector styles */
            .icon-selector {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin-top: 8px;
            }

            .icon-option {
                width: 40px;
                height: 40px;
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                font-size: 1.1rem;
            }

            .icon-option:hover {
                background: #e2e8f0;
                border-color: #1e40af;
            }

            .icon-option.selected {
                background: #1e40af;
                color: white;
                border-color: #1e40af;
            }

            .task-details h4 {
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 4px;
            }

            .task-details p {
                font-size: 0.875rem;
                color: #64748b;
            }

            .task-reward {
                display: flex;
                align-items: center;
                gap: 4px;
                font-weight: 600;
                color: #059669;
            }

            /* Calendar */
            .calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
                margin-top: 16px;
            }

            .calendar-day {
                aspect-ratio: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }

            .calendar-day.today {
                background: #1e40af;
                color: white;
                font-weight: 600;
            }

            .calendar-day.active {
                background: #dcfce7;
                color: #059669;
                border: 2px solid #059669;
            }

            .calendar-day.selected {
                background: #dbeafe;
                border: 2px solid #1e40af;
            }

            .calendar-day:hover {
                background: #f1f5f9;
            }

            .calendar-day.activity-high::after {
                content: "";
                position: absolute;
                bottom: 2px;
                right: 2px;
                width: 6px;
                height: 6px;
                background: #059669;
                border-radius: 50%;
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
            }

            .calendar-nav {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 8px 12px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .calendar-nav:hover {
                background: #f1f5f9;
                border-color: #1e40af;
            }

            .month-title {
                font-weight: 600;
                color: #1e293b;
                flex: 1;
                text-align: center;
            }

            /* Achievements */
            .achievements {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-top: 16px;
            }

            .achievement-badge {
                padding: 8px 16px;
                background: #fef3c7;
                color: #92400e;
                border-radius: 20px;
                font-size: 0.875rem;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                border: 1px solid #fbbf24;
            }

            /* Rewards */
            .reward-item {
                display: flex;
                align-items: center;
                padding: 12px;
                background: #f0f9ff;
                border-radius: 12px;
                margin-bottom: 12px;
            }

            /* Rewards grid visualization */
            .rewards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 12px;
            }
            .reward-card {
                position: relative;
                padding: 14px 12px 12px 12px;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.04);
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .reward-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            }
            .reward-card .rc-top {
                display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;
            }
            .reward-chip {
                display:inline-flex; align-items:center; gap:6px;
                background: #eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:4px 8px; border-radius:999px; font-size:0.75rem; font-weight:700;
            }
            .reward-title { font-weight:600; color:#1f2937; }
            .reward-date-2 { font-size:0.75rem; color:#64748b; margin-top:6px; }

            .reward-icon {
                width: 40px;
                height: 40px;
                background: #1e40af;
                color: white;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 12px;
            }

            .reward-info h4 {
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 4px;
            }

            .reward-date {
                font-size: 0.75rem;
                color: #64748b;
            }

            /* Buttons */
            .btn {
                padding: 12px 24px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: #1e40af;
                color: white;
            }

            .btn-primary:hover {
                background: #1d4ed8;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: #f8fafc;
                color: #64748b;
                border: 1px solid #e2e8f0;
            }

            .btn-secondary:hover {
                background: #f1f5f9;
            }

            /* Modal */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal.show {
                display: flex;
            }

            .modal-content {
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header {
                margin-bottom: 20px;
            }

            .modal-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1e293b;
            }

            .close-btn {
                position: absolute;
                top: 16px;
                right: 16px;
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #64748b;
            }

            /* Form */
            .form-group {
                margin-bottom: 16px;
            }

            .form-label {
                display: block;
                margin-bottom: 6px;
                font-weight: 500;
                color: #374151;
            }

            .form-input {
                width: 100%;
                padding: 12px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                font-size: 1rem;
                transition: border-color 0.2s ease;
            }

            .form-input:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
            }

            /* Notifications */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                display: none;
                align-items: center;
                gap: 12px;
                min-width: 300px;
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25);
            }

            .notification.show {
                display: flex;
                animation: slideIn 0.3s ease;
            }

            .notification.success {
                background: #059669;
            }

            .notification.error {
                background: #dc2626;
            }

            .notification.warning {
                background: #d97706;
            }

            .notification.info {
                background: #1e40af;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            /* Responsive */
            @media (max-width: 768px) {
                .container {
                    padding: 16px;
                }

                .main-header h1 {
                    font-size: 2rem;
                }

                .grid-cols-3 {
                    grid-template-columns: 1fr;
                }

                .grid-cols-2 {
                    grid-template-columns: 1fr;
                }

                .stat-value {
                    font-size: 2.5rem;
                }

                .calendar {
                    gap: 4px;
                }

                .modal-content {
                    margin: 16px;
                    width: calc(100% - 32px);
                }
            }

            /* Loading animations */
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .loading {
                animation: pulse 2s infinite;
            }

            /* Task completion animation */
            @keyframes taskComplete {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
                100% {
                    transform: scale(1);
                }
            }

            .task-completed {
                animation: taskComplete 0.6s ease;
                background: #dcfce7 !important;
                border-color: #059669 !important;
            }

            /* Level up animation */
            @keyframes levelUp {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.3);
                }
                100% {
                    transform: scale(1);
                }
            }

            .level-up {
                animation: levelUp 1s ease;
            }

            /* Delete Button */
            .btn-icon-delete {
                width: 32px;
                height: 32px;
                background: #fee2e2;
                color: #dc2626;
                border: 1px solid #fecaca;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                font-size: 0.875rem;
            }

            .btn-icon-delete:hover {
                background: #fecaca;
                border-color: #dc2626;
                transform: scale(1.05);
            }

            /* Settings Panel */
            .settings-panel {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .settings-btn, .analytics-btn {
                width: 50px;
                height: 50px;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                transition: all 0.3s ease;
                color: white;
            }

            .settings-btn {
                background: #1e40af;
                box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            }

            .settings-btn:hover {
                background: #1d4ed8;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(30, 64, 175, 0.4);
            }

            .analytics-btn {
                background: linear-gradient(135deg, #059669, #10b981);
                box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
            }

            .analytics-btn:hover {
                background: linear-gradient(135deg, #047857, #059669);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
            }

            .settings-menu {
                position: absolute;
                top: 60px;
                left: 0;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                padding: 8px;
                min-width: 200px;
                display: none;
            }

            .settings-menu.show {
                display: block;
                animation: fadeInDown 0.3s ease;
            }

            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .settings-item {
                padding: 12px 16px;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.2s ease;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 0.875rem;
                color: #374151;
            }

            .settings-item:hover {
                background: #f3f4f6;
            }

            .settings-item.danger {
                color: #dc2626;
            }

            .settings-item.danger:hover {
                background: #fee2e2;
            }

            /* File input styling */
            .file-input {
                display: none;
            }

            /* Other month days */
            .calendar-day.other-month {
                opacity: 0.3;
            }

            /* Weekly Bar Chart */
            .weekly-chart {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 12px;
                align-items: end;
                margin-top: 16px;
            }
            .weekly-chart .bar {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
            }
            .weekly-chart .bar-column {
                position: relative;
                width: 100%;
                height: 110px;
                background: #e2e8f0;
                border-radius: 8px;
                overflow: hidden;
            }
            .weekly-chart .bar-value {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(180deg, #93c5fd, #1e40af);
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                transition: height 0.6s ease;
            }
            .weekly-chart .bar-xp {
                font-size: 0.75rem;
                color: #1e40af;
                font-weight: 600;
            }
            .weekly-chart .bar-label {
                font-size: 0.75rem;
                color: #64748b;
                font-weight: 600;
            }

            /* Welcome Modal */
            .welcome-hero {
                background: linear-gradient(135deg, #1e40af, #3b82f6);
                color: white;
                padding: 20px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                box-shadow: inset 0 -20px 40px rgba(0,0,0,0.1);
            }
            .welcome-hero i { font-size: 1.5rem; }
            .welcome-title {
                font-size: 1.25rem;
                font-weight: 700;
            }
            .welcome-text {
                color: #1f2937;
                line-height: 1.5;
            }
            .welcome-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

            /* Autocomplete for reward ideas */
            .autocomplete-wrap { position: relative; }
            .autocomplete-list {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                margin-top: 4px;
                max-height: 220px;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                display: none;
                z-index: 1002;
            }
            .autocomplete-item {
                padding: 10px 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                cursor: pointer;
            }
            .autocomplete-item:hover { background: #f3f4f6; }
            .autocomplete-text { color: #1f2937; font-size: 0.95rem; }
            .autocomplete-remove {
                color: #dc2626;
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 4px;
                border-radius: 6px;
            }
            .autocomplete-remove:hover { background: #fee2e2; }

            /* Analytics Modal Styles */
            .analytics-modal .modal-content {
                max-width: 95vw;
                width: 1400px;
                max-height: 95vh;
                padding: 32px;
            }

            .analytics-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 32px;
                padding-bottom: 20px;
                border-bottom: 2px solid #e2e8f0;
            }

            .analytics-title {
                display: flex;
                align-items: center;
                gap: 16px;
                font-size: 2rem;
                font-weight: 700;
                color: #1e293b;
            }

            .analytics-title i {
                color: #059669;
                font-size: 1.8rem;
            }

            .analytics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 24px;
                margin-bottom: 32px;
            }

            .analytics-card {
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                padding: 24px;
                border: 1px solid #f1f5f9;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .analytics-card:hover {
                box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                transform: translateY(-2px);
            }

            .analytics-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #1e40af, #3b82f6, #059669, #10b981);
            }

            .analytics-card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
            }

            .analytics-card-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: #1e293b;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .analytics-card-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.9rem;
                color: white;
            }

            .chart-container {
                position: relative;
                height: 200px;
                margin-bottom: 16px;
            }

            .chart-large {
                height: 300px;
            }

            .chart-small {
                height: 150px;
            }

            .stat-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f1f5f9;
            }

            .stat-row:last-child {
                border-bottom: none;
            }

            .stat-label {
                color: #64748b;
                font-size: 0.9rem;
            }

            .stat-value {
                font-weight: 600;
                color: #1e293b;
            }

            .progress-ring {
                width: 120px;
                height: 120px;
                margin: 0 auto;
                position: relative;
            }

            .progress-ring svg {
                width: 100%;
                height: 100%;
                transform: rotate(-90deg);
            }

            .progress-ring-bg {
                fill: none;
                stroke: #e2e8f0;
                stroke-width: 8;
            }

            .progress-ring-fill {
                fill: none;
                stroke: #1e40af;
                stroke-width: 8;
                stroke-linecap: round;
                transition: stroke-dasharray 0.5s ease;
            }

            .progress-ring-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                font-size: 1.2rem;
                font-weight: 700;
                color: #1e293b;
            }

            .heatmap {
                display: grid;
                grid-template-columns: repeat(53, 1fr);
                gap: 2px;
                margin: 16px 0;
            }

            .heatmap-cell {
                width: 12px;
                height: 12px;
                background: #f1f5f9;
                border-radius: 2px;
                transition: all 0.2s ease;
            }

            .heatmap-cell[data-level="1"] { background: #dcfce7; }
            .heatmap-cell[data-level="2"] { background: #bbf7d0; }
            .heatmap-cell[data-level="3"] { background: #86efac; }
            .heatmap-cell[data-level="4"] { background: #4ade80; }
            .heatmap-cell[data-level="5"] { background: #22c55e; }

            .analytics-tabs {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
                background: #f8fafc;
                padding: 8px;
                border-radius: 12px;
            }

            .analytics-tab {
                padding: 12px 20px;
                border-radius: 8px;
                background: transparent;
                border: none;
                color: #64748b;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .analytics-tab.active {
                background: white;
                color: #1e40af;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .analytics-tab:hover:not(.active) {
                background: #f1f5f9;
                color: #1e293b;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Activity item styles for delete functionality */
            .activity-item {
                position: relative;
                padding: 8px 12px 8px 8px;
                background: #f0fdf4;
                border-radius: 6px;
                margin-bottom: 4px;
                border-left: 3px solid #059669;
                transition: all 0.2s ease;
            }
            .activity-item:hover {
                background: #dcfce7;
                padding-right: 32px;
            }
            .activity-delete {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 20px;
                height: 20px;
                background: #fee2e2;
                color: #dc2626;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.75rem;
                display: none;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }
            .activity-item:hover .activity-delete {
                display: flex;
            }
            .activity-delete:hover {
                background: #fecaca;
                transform: translateY(-50%) scale(1.1);
            }

            /* Demo badge */
            .demo-badge {
                display: inline-flex;
                align-items: center;
                height: 26px;
                padding: 0 10px;
                border-radius: 999px;
                background: #f59e0b;
                color: white;
                font-size: 0.75rem;
                font-weight: 700;
            }
        </style>
    </head>
    <body>
        <!-- Settings Panel -->
        <div class="settings-panel">
            <button class="settings-btn" onclick="toggleSettingsMenu()" aria-label="Открыть настройки" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-cog"></i>
            </button>
            <button class="analytics-btn" onclick="showAnalyticsModal()" aria-label="Открыть аналитику" title="Аналитика и статистика">
                <i class="fas fa-chart-line"></i>
            </button>
            <div class="settings-menu" id="settingsMenu">
                <div class="settings-item" onclick="showChangeAccountModal()">
                    <i class="fas fa-user-shield"></i>
                    Сменить учетную запись
                </div>
                                 <div class="settings-item" onclick="exportData()">
                     <i class="fas fa-download"></i>
                     Экспорт данных
                 </div>
                 <div class="settings-item" onclick="document.getElementById('importFile').click()">
                     <i class="fas fa-upload"></i>
                     Импорт данных
                 </div>
                 
                 <div class="settings-item danger" onclick="clearTasks()">
                     <i class="fas fa-trash"></i>
                     Очистить задания
                 </div>
                 <div class="settings-item danger" onclick="clearRewards()">
                     <i class="fas fa-gift"></i>
                     Очистить награды
                 </div>
                 <div class="settings-item danger" onclick="resetProgress()">
                     <i class="fas fa-arrows-rotate"></i>
                     Сбросить прогресс
                 </div>
            </div>
            <input type="file" id="importFile" class="file-input" accept="application/json,.json" onchange="importData(event)">
        </div>

        



        <div class="container">
            <!-- Main Header -->
            <div class="card main-header">
                <h1>Авторская программа изучения английского языка</h1>
                <p>Изучение английского языка</p>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-3">
                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-label">Текущий уровень</div>
                    <div class="stat-value" id="currentLevel">15</div>
                    <div style="font-size: 0.875rem; color: #64748b">
                        Продвинутый
                    </div>
                </div>

                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-label">Общий опыт</div>
                    <div class="stat-value" id="totalXP">4250</div>
                    <div style="font-size: 0.875rem; color: #64748b">XP</div>
                </div>

                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-label">Серия</div>
                    <div class="stat-value" id="currentStreak">0 / 0</div>
                    <div id="streakSubtitle" style="font-size: 0.875rem; color: #64748b">
                        учебных дней с начала (Пн–Пт)
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2">
                <!-- Progress Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            Прогресс обучения
                        </h2>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button class="calendar-nav" id="weekPrevBtn" onclick="changeWeek(-1)" title="Предыдущая неделя">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="month-title" id="weekRangeLabel" style="text-align:left; min-width: 220px;">
                                    Текущая неделя
                                </div>
                                <button class="calendar-nav" id="weekNextBtn" onclick="changeWeek(1)" title="Следующая неделя">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 12px;
                            "
                        >
                            <span style="font-weight: 600; color: #1e293b"
                                >До следующего уровня</span
                            >
                            <span
                                style="font-weight: 600; color: #1e40af"
                                id="xpProgress"
                                >—</span
                            >
                        </div>
                        <div class="progress-container">
                            <div
                                class="progress-bar"
                                id="levelProgress"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>

                    <div style="margin-top: 32px">
                        <h3
                            style="
                                font-size: 1rem;
                                font-weight: 600;
                                color: #1e293b;
                                margin-bottom: 16px;
                            "
                        >
                            Еженедельные цели
                        </h3>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 12px;
                            "
                        >
                            <span>Недельный прогресс</span>
                            <span
                                style="font-weight: 600; color: #1e40af"
                                id="weeklyProgress"
                                >—</span
                            >
                        </div>
                        <div class="progress-container" id="weeklyProgressContainer">
                            <div class="progress-marker" id="marker500" style="left: calc(500/750 * 100%);">
                                <div class="progress-label">500 XP</div>
                            </div>
                            <div class="progress-marker right" id="marker750" style="left: 100%;">
                                <div class="progress-label">750 XP</div>
                            </div>
                            <div class="progress-bar" id="weeklyBar" style="width: 0%"></div>
                        </div>

                        

                        <div id="weeklyChart" class="weekly-chart" aria-label="XP за дни недели"></div>

                        <div style="margin-top: 24px;">
                            <h3
                                style="
                                    font-size: 1rem;
                                    font-weight: 600;
                                    color: #1e293b;
                                    margin-bottom: 12px;
                                "
                            >
                                Прогресс за месяц
                            </h3>
                            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
                                <span>Месячный прогресс</span>
                                <span id="monthlyProgressText" style="font-weight:600; color:#1e40af;">—</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" id="monthlyBar" style="width: 0%"></div>
                            </div>
                            <div id="monthlyInlineChart" class="weekly-chart" aria-label="XP по дням месяца" style="grid-template-columns: repeat( auto-fit, minmax(16px, 1fr) );"></div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="card">
                    <div
                        class="card-header"
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        "
                    >
                        <h2 class="card-title">
                            <i class="fas fa-tasks"></i>
                            Задания
                        </h2>
                        <button
                            class="btn btn-primary"
                            onclick="showTaskModal()"
                        >
                            <i class="fas fa-plus"></i>
                            Добавить
                        </button>
                    </div>

                    <div class="task-list" id="taskList">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2">
                <!-- Achievements and Rewards -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-medal"></i>
                            Достижения и награды
                        </h2>
                    </div>

                    <div>
                        <h3
                            style="
                                font-size: 0.875rem;
                                font-weight: 600;
                                color: #64748b;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                                margin-bottom: 12px;
                            "
                        >
                            Полученные достижения
                        </h3>
                        <div class="achievements">
                            <div class="achievement-badge">
                                <i class="fas fa-fire"></i>
                                Огненная серия
                            </div>
                            <div class="achievement-badge">
                                <i class="fas fa-star"></i>
                                Первые шаги
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 32px">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">
                                Последние награды
                            </h3>
                            <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                                <div class="redeem-stars-container" aria-label="Банк звезд" title="Ваши накопленные звезды для награды">
                                    <i class="fas fa-star redeem-star" id="bankStar1"></i>
                                    <i class="fas fa-star redeem-star" id="bankStar2"></i>
                                    <i class="fas fa-star redeem-star" id="bankStar3"></i>
                                </div>
                                <div style="min-width: 70px; text-align: right; font-weight:600; color:#1e40af;" id="bankStarsText">0 ⭐</div>
                                <button class="btn btn-secondary" id="ideaBtn" onclick="showIdeaModal()" title="Придумать и сохранить награду">
                                    <i class="fas fa-lightbulb"></i>
                                    Придумать награду
                                </button>
                                <button class="btn btn-primary" onclick="showRewardModal()" id="redeemBtn">
                                    <i class="fas fa-gift"></i>
                                    Получить
                                </button>
                            </div>
                        </div>
                        <div id="plannedRewardCard" style="display:none; background:#fffbeb; border:1px solid #fde68a; color:#92400e; padding:12px; border-radius:10px; margin-bottom:12px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <div style="display:flex; align-items:center; gap:8px; font-weight:600;">
                                    <i class="fas fa-pen-to-square"></i>
                                    Запланированная награда:
                                </div>
                                <div style="font-size:0.9rem; color:#78350f;" id="plannedRewardText">—</div>
                            </div>
                        </div>
                        <div id="rewardsList">
                            <div
                                style="
                                    text-align: center;
                                    padding: 20px;
                                    color: #64748b;
                                    font-size: 0.875rem;
                                "
                            >
                                Пока нет полученных наград
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-calendar-alt"></i>
                            Календарь активности
                        </h2>
                    </div>

                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="month-title" id="monthTitle">
                            Январь 2025
                        </div>
                        <button class="calendar-nav" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(7, 1fr);
                            gap: 8px;
                            margin-bottom: 8px;
                            font-size: 0.75rem;
                            font-weight: 600;
                            color: #64748b;
                            text-align: center;
                        "
                    >
                        <div>ПН</div>
                        <div>ВТ</div>
                        <div>СР</div>
                        <div>ЧТ</div>
                        <div>ПТ</div>
                        <div>СБ</div>
                        <div>ВС</div>
                    </div>

                    <div class="calendar" id="calendar">
                        <!-- Calendar days will be generated here -->
                    </div>

                    <div
                        style="
                            margin-top: 20px;
                            padding-top: 16px;
                            border-top: 1px solid #e2e8f0;
                        "
                    >
                        <h4
                            style="
                                font-weight: 600;
                                color: #1e293b;
                                margin-bottom: 12px;
                            "
                            id="selectedDateTitle"
                        >
                            Активность за сегодня
                        </h4>
                        <div
                            id="dayActivity"
                            style="font-size: 0.875rem; color: #64748b"
                        >
                            Пока нет активности за выбранный день
                        </div>
                    </div>
                </div>
                

            </div>
        </div>



        <!-- Task Modal -->
        <div class="modal" id="taskModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
                <button class="close-btn" onclick="hideTaskModal()">
                    &times;
                </button>
                <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">Добавить новое задание</h3>
                </div>

                <form id="taskForm" onsubmit="addTask(event)" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label">Название задания</label>
                        <input
                            type="text"
                            class="form-input"
                            id="taskName"
                            name="taskName"
                            placeholder="Например: Изучение новых слов"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            inputmode="text"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Описание</label>
                        <textarea
                            class="form-input"
                            id="taskDescription"
                            name="taskDescription"
                            rows="3"
                            placeholder="Краткое описание задания"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Иконка задания</label>
                        <div class="icon-selector" id="iconSelector">
                            <!-- Icons will be populated by JavaScript -->
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label">Награда (XP)</label>
                            <input
                                type="number"
                                class="form-input"
                                id="taskXP"
                                name="taskXP"
                                value="50"
                                min="10"
                                max="500"
                                autocomplete="off"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Длительность (мин)</label>
                            <input
                                type="number"
                                class="form-input"
                                id="taskDuration"
                                name="taskDuration"
                                value="15"
                                min="5"
                                max="120"
                                autocomplete="off"
                            />
                        </div>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                            margin-top: 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="hideTaskModal()"
                        >
                            Отмена
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Добавить задание
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reward Modal -->
        <div class="modal" id="rewardModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="rewardModalTitle">
                <button class="close-btn" onclick="hideRewardModal()">
                    &times;
                </button>
                <div class="modal-header">
                    <h3 class="modal-title" id="rewardModalTitle">Получить награду</h3>
                </div>

                <form id="rewardForm" onsubmit="addReward(event)">
                    <div class="form-group">
                        <label class="form-label">Запланированная награда</label>
                        <div id="plannedRewardDisplay" style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; color: #1e293b;">
                            —
                        </div>
                    </div>

                    <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Доступно звезд:</span>
                            <span style="font-weight: 600; color: #1e40af" id="availableStars">0 ⭐</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span>Требуется для награды:</span>
                            <span style="font-weight: 600; color: #1e293b">3 ⭐</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="hideRewardModal()"><i class="fas fa-times"></i> Отмена</button>
                        <button type="submit" class="btn btn-primary" id="confirmRedeemBtn">
                            <i class="fas fa-gift"></i>
                            Получить награду
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Idea Modal -->
        <div class="modal" id="ideaModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="ideaModalTitle">
                <button class="close-btn" onclick="hideIdeaModal()">&times;</button>
                <div class="modal-header">
                    <h3 class="modal-title" id="ideaModalTitle">Придумать награду</h3>
                </div>
                <form id="ideaForm" onsubmit="saveRewardIdea(event)">
                    <div class="form-group">
                        <label class="form-label">Название награды</label>
                        <div class="autocomplete-wrap">
                            <input type="text" class="form-input" id="ideaDescription" placeholder="Например: Поход в кино" required autocomplete="off" />
                            <div class="autocomplete-list" id="ideaAutocomplete"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="hideIdeaModal()"><i class="fas fa-times"></i> Отмена</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i>
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification" role="status" aria-live="polite" aria-atomic="true">
            <i class="fas fa-check-circle"></i>
            <span id="notificationMessage"></span>
        </div>

        <!-- Account Modal -->
        <div class="modal" id="accountModal">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle" style="max-width:520px; position:relative;">
                <div class="modal-header">
                    <h3 class="modal-title" id="accountModalTitle">Выберите учетную запись</h3>
                </div>
                <div style="display:flex; gap:12px; flex-direction:column;">
                    <button class="btn btn-primary" onclick="selectAccount('viewer')" style="justify-content:center;">
                        <i class="fas fa-user"></i> Михаил (только просмотр)
                    </button>
                                         <button class="btn btn-secondary" onclick="selectAccount('admin')" style="justify-content:center; background: #fbbf24; color: #92400e; border-color: #f59e0b;">
                         <i class="fas fa-crown"></i> Admin (полные права)
                     </button>
                </div>
            </div>
        </div>

        <!-- Analytics Modal -->
        <div class="modal analytics-modal" id="analyticsModal">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="analyticsModalTitle">
                <button class="close-btn" onclick="hideAnalyticsModal()">&times;</button>
                
                <div class="analytics-header">
                    <div class="analytics-title" id="analyticsModalTitle">
                        <i class="fas fa-chart-line"></i>
                        Аналитика обучения
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="demoBadge" class="demo-badge" style="display: none;">Демо</span>
                        <button class="btn btn-secondary" id="toggleDemoBtn" onclick="toggleDemoAnalytics()" title="Включить демо визуализацию">Демо</button>
                    </div>
                </div>

                <div class="analytics-tabs">
                    <button class="analytics-tab active" onclick="switchAnalyticsTab('overview')">Обзор</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('progress')">Прогресс</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('patterns')">Паттерны</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab('achievements')">Достижения</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <div class="analytics-grid">
                        <!-- Total Stats Card -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    Общая статистика
                                </div>
                            </div>
                            <div id="totalStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Всего дней с активностью</span>
                                    <span class="stat-value" id="totalActiveDays">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Всего заданий выполнено</span>
                                    <span class="stat-value" id="totalTasksCompleted">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Среднее XP в день</span>
                                    <span class="stat-value" id="avgXpPerDay">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Лучший день (XP)</span>
                                    <span class="stat-value" id="bestDay">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Level Progress Ring -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                        <i class="fas fa-level-up-alt"></i>
                                    </div>
                                    Прогресс уровня
                                </div>
                            </div>
                            <div class="progress-ring" id="levelProgressRing">
                                <svg viewBox="0 0 120 120">
                                    <circle class="progress-ring-bg" cx="60" cy="60" r="52"></circle>
                                    <circle class="progress-ring-fill" cx="60" cy="60" r="52" 
                                            stroke-dasharray="0 327" id="levelRingFill"></circle>
                                </svg>
                                <div class="progress-ring-text" id="levelRingText">Lv.1</div>
                            </div>
                        </div>

                        <!-- Weekly XP Trend -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        <i class="fas fa-chart-area"></i>
                                    </div>
                                    Тренд XP по неделям
                                </div>
                            </div>
                            <div class="chart-container chart-large" id="weeklyTrendChart"></div>
                        </div>

                        <!-- Learning Streak -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                                        <i class="fas fa-fire"></i>
                                    </div>
                                    Статистика серий
                                </div>
                            </div>
                            <div id="streakStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Текущая серия</span>
                                    <span class="stat-value" id="currentStreakStat">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Лучшая серия</span>
                                    <span class="stat-value" id="bestStreak">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Консистентность</span>
                                    <span class="stat-value" id="consistency">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stars Analytics -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    Звезды и награды
                                </div>
                            </div>
                            <div id="starsStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Всего звезд заработано</span>
                                    <span class="stat-value" id="totalStarsEarned">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Звезд потрачено</span>
                                    <span class="stat-value" id="starsSpent">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Наград получено</span>
                                    <span class="stat-value" id="rewardsCount">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Tab -->
                <div class="tab-content" id="progress-tab">
                    <div class="analytics-grid">
                        <!-- Activity Heatmap -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    Карта активности (последний год)
                                </div>
                            </div>
                            <div id="activityHeatmap" class="heatmap"></div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; font-size: 0.85rem; color: #64748b;">
                                <span>Меньше</span>
                                <div style="display: flex; gap: 3px;">
                                    <div class="heatmap-cell"></div>
                                    <div class="heatmap-cell" data-level="1"></div>
                                    <div class="heatmap-cell" data-level="2"></div>
                                    <div class="heatmap-cell" data-level="3"></div>
                                    <div class="heatmap-cell" data-level="4"></div>
                                    <div class="heatmap-cell" data-level="5"></div>
                                </div>
                                <span>Больше</span>
                            </div>
                        </div>

                        <!-- Monthly Progress -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    XP по месяцам
                                </div>
                            </div>
                            <div class="chart-container" id="monthlyXpChart"></div>
                        </div>

                        <!-- Task Distribution -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    Типы заданий
                                </div>
                            </div>
                            <div class="chart-container chart-small" id="taskDistributionChart"></div>
                        </div>

                        <!-- Level Timeline -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    Хронология уровней
                                </div>
                            </div>
                            <div class="chart-container" id="levelTimelineChart"></div>
                        </div>
                    </div>
                </div>

                <!-- Patterns Tab -->
                <div class="tab-content" id="patterns-tab">
                    <div class="analytics-grid">
                        <!-- Daily Pattern -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8);">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    Дни недели
                                </div>
                            </div>
                            <div class="chart-container" id="weekdayPatternChart"></div>
                        </div>

                        <!-- Performance Trends -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        <i class="fas fa-trending-up"></i>
                                    </div>
                                    Эффективность
                                </div>
                            </div>
                            <div id="performanceContent">
                                <div class="stat-row">
                                    <span class="stat-label">Самый продуктивный день недели</span>
                                    <span class="stat-value" id="bestWeekday">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Среднее заданий в день</span>
                                    <span class="stat-value" id="avgTasksPerDay">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Рост XP (последние 4 недели)</span>
                                    <span class="stat-value" id="xpGrowth">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Study Sessions -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    История сессий обучения
                                </div>
                            </div>
                            <div class="chart-container" id="sessionsChart"></div>
                        </div>

                        <!-- Prediction -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                        <i class="fas fa-crystal-ball"></i>
                                    </div>
                                    Прогнозы
                                </div>
                            </div>
                            <div id="predictionContent">
                                <div class="stat-row">
                                    <span class="stat-label">До 100 уровня</span>
                                    <span class="stat-value" id="timeToMax">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Следующая звезда через</span>
                                    <span class="stat-value" id="nextStarTime">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Месячная цель (1000 XP)</span>
                                    <span class="stat-value" id="monthlyGoal">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements Tab -->
                <div class="tab-content" id="achievements-tab">
                    <div class="analytics-grid">
                        <!-- Milestones -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        <i class="fas fa-medal"></i>
                                    </div>
                                    Ключевые достижения
                                </div>
                            </div>
                            <div id="milestonesContent"></div>
                        </div>

                        <!-- Records -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    Рекорды
                                </div>
                            </div>
                            <div id="recordsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Максимум XP за день</span>
                                    <span class="stat-value" id="maxDayXp">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Максимум заданий за день</span>
                                    <span class="stat-value" id="maxDayTasks">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Лучшая неделя (XP)</span>
                                    <span class="stat-value" id="bestWeekXp">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Comparison -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        <i class="fas fa-chart-area"></i>
                                    </div>
                                    Сравнение периодов
                                </div>
                            </div>
                            <div class="chart-container" id="comparisonChart"><canvas id="comparisonChartCanvas" class="chart-large" aria-label="Сравнение периодов"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Modal -->
        <div class="modal" id="welcomeModal">
            <div class="modal-content" style="position: relative; max-width: 640px;" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
                <button class="close-btn" onclick="hideWelcomeModal()">&times;</button>
                <div class="welcome-hero">
                    <i class="fas fa-sparkles"></i>
                    <div class="welcome-title" id="welcomeModalTitle">Welcome, Mikhail!</div>
                </div>
                <div class="welcome-text" id="welcomeMessage">
                    Great to see you! You're on a powerful journey to master English—let's make today count.
                </div>
                <div class="welcome-actions">
                    <button class="btn btn-secondary" onclick="hideWelcomeModal()">Close</button>
                    <button class="btn btn-primary" onclick="hideWelcomeModal()"><i class="fas fa-bolt"></i> Let's go!</button>
                </div>
            </div>
        </div>

        

        <script>
            // Available icons for tasks
            const availableIcons = [
                { class: "fas fa-book", name: "Книга" },
                { class: "fas fa-pencil-alt", name: "Карандаш" },
                { class: "fas fa-headphones", name: "Наушники" },
                { class: "fas fa-microphone", name: "Микрофон" },
                { class: "fas fa-eye", name: "Глаз" },
                { class: "fas fa-brain", name: "Мозг" },
                { class: "fas fa-lightbulb", name: "Лампочка" },
                { class: "fas fa-star", name: "Звезда" },
                { class: "fas fa-trophy", name: "Трофей" },
                { class: "fas fa-medal", name: "Медаль" },
                { class: "fas fa-fire", name: "Огонь" },
                { class: "fas fa-rocket", name: "Ракета" },
                { class: "fas fa-graduation-cap", name: "Диплом" },
                { class: "fas fa-chalkboard-teacher", name: "Учитель" },
                { class: "fas fa-language", name: "Язык" },
                { class: "fas fa-spell-check", name: "Проверка" },
                { class: "fas fa-clock", name: "Часы" },
                { class: "fas fa-target", name: "Цель" },
                { class: "fas fa-chart-line", name: "График" },
                { class: "fas fa-gamepad", name: "Игра" }
            ];

            // Application State
            let appState = {
                user: {
                    id: "demo-user",
                    username: "demo",
                },
                role: 'viewer',
                progress: {
                    level: 15,
                    totalXP: 4250,
                    currentLevelXP: 0,
                    streak: 12,
                    weeklyXP: 340,
                    weeklyStars: 0,
                    starBank: 0,
                    weekStartKey: null,
                },
                demoAnalytics: { enabled: false },
                tasks: [
                    {
                        id: 1,
                        name: "Изучение новых слов",
                        description: "Выучить 10 новых английских слов",
                        xpReward: 50,
                        duration: 15,
                        icon: "fas fa-book",
                        category: "vocabulary",
                    },
                    {
                        id: 2,
                        name: "Грамматические упражнения",
                        description: "Выполнить упражнения на Present Simple",
                        xpReward: 75,
                        duration: 20,
                        icon: "fas fa-pencil-alt",
                        category: "grammar",
                    },
                    {
                        id: 3,
                        name: "Аудирование",
                        description: "Прослушать диалог и ответить на вопросы",
                        xpReward: 60,
                        duration: 25,
                        icon: "fas fa-headphones",
                        category: "listening",
                    },
                ],
                rewards: [],
                currentMonth: new Date(),
                selectedDate: new Date(),
                activityData: {},
                rewardPlan: { description: "" },
                resetDate: new Date(),
                progressView: { weekOffset: 0, monthOffset: 0 },
            };

            // Demo analytics helpers
            let demoStateCache = null;
            function seededRandom(seed) {
                let x = 0;
                for (let i = 0; i < seed.length; i++) x = (x * 31 + seed.charCodeAt(i)) >>> 0;
                return function() {
                    // xorshift32
                    x ^= x << 13; x >>>= 0;
                    x ^= x >>> 17; x >>>= 0;
                    x ^= x << 5; x >>>= 0;
                    return (x >>> 0) / 0xffffffff;
                };
            }
            function randomInRange(rng, min, max) {
                return Math.floor(rng() * (max - min + 1)) + min;
            }
            function buildDemoState() {
                const rng = seededRandom('english-analytics-demo');
                const today = new Date();
                const start = new Date();
                start.setMonth(start.getMonth() - 6);
                start.setHours(0,0,0,0);

                const activityData = {};
                const taskCatalog = [
                    { name: 'Изучение новых слов', xp: 40, category: 'vocabulary' },
                    { name: 'Грамматические упражнения', xp: 60, category: 'grammar' },
                    { name: 'Аудирование', xp: 50, category: 'listening' },
                    { name: 'Разговорная практика', xp: 70, category: 'speaking' },
                    { name: 'Чтение текста', xp: 45, category: 'reading' },
                ];

                // simulate daily activity with weekly cycles and occasional spikes
                let cursor = new Date(start);
                let totalXP = 0;
                const weekTotals = {};
                while (cursor <= today) {
                    const dateKey = formatDate(cursor);
                    const day = cursor.getDay(); // 0..6
                    const isWeekend = day === 0 || day === 6;
                    const sessions = isWeekend ? (rng() < 0.35 ? 1 : 0) : (rng() < 0.85 ? (rng() < 0.5 ? 2 : 1) : 0);
                    if (sessions > 0) {
                        activityData[dateKey] = [];
                        for (let s = 0; s < sessions; s++) {
                            const t = taskCatalog[randomInRange(rng, 0, taskCatalog.length - 1)];
                            const variance = randomInRange(rng, -15, 25);
                            const xp = Math.max(15, t.xp + variance);
                            totalXP += xp;
                            activityData[dateKey].push({
                                taskId: s + 1,
                                taskName: t.name,
                                xpEarned: xp,
                                completedAt: new Date(cursor),
                                category: t.category,
                            });
                        }
                        const weekKey = getWeekStartKey(cursor);
                        weekTotals[weekKey] = (weekTotals[weekKey] || 0) + activityData[dateKey].reduce((a,b)=>a+(b.xpEarned||0),0);
                    }
                    cursor.setDate(cursor.getDate() + 1);
                }

                // compute level based on 810 xp per level
                const xpPerLevel = 810;
                const level = Math.min(100, Math.floor(totalXP / xpPerLevel) + 1);
                const currentLevelXP = level >= 100 ? 0 : (totalXP % xpPerLevel);

                // current week
                const currentWeekKey = getWeekStartKey(new Date());
                const weeklyXP = weekTotals[currentWeekKey] || 0;
                const weeklyStars = calculateWeeklyStars(weeklyXP);

                // stars and rewards demo
                let totalStars = 0;
                Object.values(weekTotals).forEach(xp => totalStars += calculateWeeklyStars(xp));
                const rewardsCount = Math.max(1, Math.floor(totalStars / 5));
                const rewards = [];
                for (let i = 0; i < rewardsCount; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i * 14 - randomInRange(rng, 0, 3));
                    rewards.push({ id: Date.now() - i, description: 'Демо-награда #' + (i+1), starsUsed: 3, redeemedAt: d });
                }
                const starBank = Math.max(0, totalStars - rewards.length * 3);

                return {
                    user: appState.user,
                    progress: {
                        level,
                        totalXP,
                        currentLevelXP,
                        streak: 0,
                        weeklyXP,
                        weeklyStars,
                        starBank,
                        weekStartKey: currentWeekKey,
                    },
                    tasks: appState.tasks,
                    rewards,
                    currentMonth: appState.currentMonth,
                    selectedDate: appState.selectedDate,
                    activityData,
                    rewardPlan: { description: 'Демо: поход в кино' },
                    resetDate: start,
                    demoAnalytics: { enabled: true },
                };
            }
            function getEffectiveState() {
                if (appState.demoAnalytics && appState.demoAnalytics.enabled) {
                    if (!demoStateCache) demoStateCache = buildDemoState();
                    return demoStateCache;
                }
                return appState;
            }

            // Utility Functions
            function formatDate(date) {
                // Local date string YYYY-MM-DD without UTC shift
                const local = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const y = local.getFullYear();
                const m = String(local.getMonth() + 1).padStart(2, '0');
                const d = String(local.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            function escapeHTML(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            const STORAGE_KEY = 'english-learning-app-state-v1';
            const IDEAS_KEY = 'english-learning-reward-ideas-v1';
            function saveState() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                } catch (e) {
                    // ignore storage errors
                }
            }

            function loadState() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (raw) {
                        const saved = JSON.parse(raw);
                        appState = { ...appState, ...saved };
                        if (saved.currentMonth) appState.currentMonth = new Date(saved.currentMonth);
                        if (saved.selectedDate) appState.selectedDate = new Date(saved.selectedDate);
                    }
                } catch (e) {
                    // ignore parse errors
                }
            }

            function applyRolePermissions() {
                const isViewer = appState.role === 'viewer';
                // Disable interactive controls for viewer (avoid disabling account modal and progress navigation)
                const controls = [
                    '.btn-icon-delete', '.activity-delete',
                    'button[onclick^="showTaskModal"]',
                    'button[onclick^="showRewardModal"]',
                    'button[onclick^="showIdeaModal"]',
                    '#settingsMenu .settings-item.danger',
                    '#importFile',
                ];
                controls.forEach(sel => document.querySelectorAll(sel).forEach(el => {
                    if (el && el.closest) {
                        if (isViewer && !el.closest('#accountModal') && !el.closest('.progress-container')) {
                            el.setAttribute('disabled', 'true');
                            el.style.pointerEvents = 'none';
                            el.style.opacity = '0.6';
                        } else {
                            el.removeAttribute('disabled');
                            el.style.pointerEvents = '';
                            el.style.opacity = '';
                        }
                    }
                }));
                // Special case: allow progress navigation for viewer
                const progressNav = document.querySelectorAll('#weekPrevBtn, #weekNextBtn');
                progressNav.forEach(el => {
                    if (el && isViewer) {
                        el.removeAttribute('disabled');
                        el.style.pointerEvents = '';
                        el.style.opacity = '';
                    }
                });
                

            }

            function showNotification(message, type = "success") {
                const notification = document.getElementById("notification");
                const messageEl = document.getElementById(
                    "notificationMessage",
                );

                messageEl.textContent = message;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove("show");
                }, 3000);
            }

            // Welcome modal texts (random unique praise each time)
            const welcomePhrases = [
                "Fantastic start, Mikhail! Every click is a step toward fluency—keep shining!",
                "Mikhail, your consistency is impressive—today's effort will compound into greatness!",
                "Brilliant move, Mikhail! Your dedication to English is what champions are made of.",
                "Mikhail, you're unstoppable! Each lesson sharpens your mind and your voice.",
                "Outstanding, Mikhail! You're building a skill that will open doors everywhere.",
                "Great energy, Mikhail! Turning intention into action—this is how mastery begins.",
                "Mikhail, amazing focus! Your future self will thank you for this exact moment.",
                "Superb, Mikhail! Small wins daily create extraordinary results—let's go!",
                "You rock, Mikhail! Today's practice brings you closer to confident English.",
                "Impressive, Mikhail! Momentum is yours—one task at a time to the top!"
            ];

            function showWelcomeModal() {
                const idx = Math.floor(Math.random() * welcomePhrases.length);
                const msg = welcomePhrases[idx];
                const welcomeEl = document.getElementById('welcomeMessage');
                if (welcomeEl) welcomeEl.textContent = msg;
                document.getElementById('welcomeModal').classList.add('show');
            }
            function hideWelcomeModal() {
                document.getElementById('welcomeModal').classList.remove('show');
            }

            function loadIdeas() {
                try {
                    const raw = localStorage.getItem(IDEAS_KEY);
                    const list = raw ? JSON.parse(raw) : [];
                    return Array.isArray(list) ? list : [];
                } catch { return []; }
            }
            function saveIdeas(list) {
                try { localStorage.setItem(IDEAS_KEY, JSON.stringify(list.slice(0, 50))); } catch {}
            }
            function addIdea(desc) {
                const ideas = loadIdeas();
                const clean = desc.trim();
                if (!clean) return;
                if (!ideas.includes(clean)) {
                    ideas.unshift(clean);
                    saveIdeas(ideas);
                }
            }
            function removeIdea(desc) {
                const ideas = loadIdeas().filter(i => i !== desc);
                saveIdeas(ideas);
            }
            function renderIdeaSuggestions(query = '') {
                const box = document.getElementById('ideaAutocomplete');
                if (!box) return;
                const ideas = loadIdeas();
                const q = query.trim().toLowerCase();
                const filtered = q ? ideas.filter(i => i.toLowerCase().includes(q)) : ideas;
                if (filtered.length === 0) { box.style.display = 'none'; box.innerHTML = ''; return; }
                box.innerHTML = filtered.map(i => `
                    <div class="autocomplete-item" data-value="${escapeHTML(i)}">
                        <div class="autocomplete-text">${escapeHTML(i)}</div>
                        <button class="autocomplete-remove" aria-label="Удалить сохраненный вариант" data-remove="${escapeHTML(i)}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
                box.style.display = 'block';
            }

            function getXPRequiredForLevel(level) {
                if (level >= 100) return 0;
                // Правило заказчика: до следующего уровня сейчас фиксировано 810 XP
                return 810;
            }

            function calculateXPProgress(currentXP, maxXP) {
                if (!maxXP || maxXP <= 0) return 100;
                return Math.min((currentXP / maxXP) * 100, 100);
            }

            function calculateWeeklyStars(weeklyXP) {
                const thresholds = [500, 750];
                return thresholds.filter((threshold) => weeklyXP >= threshold).length;
            }

            // DOM Updates
            function updateProgressDisplay() {
                const { progress } = appState;

                document.getElementById("currentLevel").textContent =
                    progress.level;
                document.getElementById("totalXP").textContent =
                    progress.totalXP.toLocaleString();
                updateStreakDisplay();

                const xpNeeded = getXPRequiredForLevel(progress.level);
                const xpRemaining = Math.max(0, xpNeeded - progress.currentLevelXP);
                const levelProgress = calculateXPProgress(progress.currentLevelXP, xpNeeded);
                document.getElementById("levelProgress").style.width = `${levelProgress}%`;
                document.getElementById("xpProgress").textContent = xpNeeded === 0 ? 'Максимальный уровень' : `${xpRemaining} XP`;

                // Update star bank and earned stars for the current week
                updateWeeklyStars();
                // Weekly and monthly sections
                updateProgressWeekSection();
                updateMonthlyProgressSection();
                updateRedeemControls();
            }

            function isWeekday(date) {
                const d = new Date(date);
                const day = d.getDay();
                return day >= 1 && day <= 5; // Mon..Fri
            }

            function hasActivityOn(date, stateOverride) {
                const state = stateOverride || appState;
                const key = formatDate(new Date(date));
                const logs = (state.activityData && state.activityData[key]);
                return Array.isArray(logs) && logs.length > 0;
            }

            function iterateDays(startDate, endDate, cb) {
                const cur = new Date(startDate);
                cur.setHours(0,0,0,0);
                const stop = new Date(endDate);
                stop.setHours(0,0,0,0);
                while (cur <= stop) {
                    cb(new Date(cur));
                    cur.setDate(cur.getDate() + 1);
                }
            }

            function updateStreakDisplay() {
                const start = new Date(appState.resetDate || new Date());
                const today = new Date();
                let studied = 0;
                let totalEligible = 0;
                iterateDays(start, today, (d) => {
                    if (isWeekday(d)) {
                        totalEligible += 1;
                        if (hasActivityOn(d)) studied += 1;
                    }
                });
                const text = `${studied} / ${totalEligible}`;
                const el = document.getElementById('currentStreak');
                if (el) el.textContent = text;
            }

            function updateWeeklyStars() {
                const stars = document.querySelectorAll("#weeklyStars .star");
                const newEarned = calculateWeeklyStars(appState.progress.weeklyXP);
                if (newEarned > (appState.progress.weeklyStars || 0)) {
                    appState.progress.starBank = (appState.progress.starBank || 0) + (newEarned - (appState.progress.weeklyStars || 0));
                }
                appState.progress.weeklyStars = newEarned;

                stars.forEach((star, index) => {
                    if (index < newEarned) star.classList.add("filled");
                    else star.classList.remove("filled");
                });

                const availableStarsEl = document.getElementById("availableStars");
                if (availableStarsEl) {
                    availableStarsEl.textContent = `${appState.progress.starBank || 0} ⭐`;
                }
                // inline available star bank
                const availableInline = document.getElementById('availableStarsInline');
                if (availableInline) availableInline.textContent = `${appState.progress.starBank || 0} ⭐`;
                // redeem stars (3) based on this week's earned stars
                const redeemStars = document.querySelectorAll('#redeemStars .redeem-star');
                redeemStars.forEach((el, idx) => {
                    if (idx < newEarned) el.classList.add('filled'); else el.classList.remove('filled');
                    if (newEarned >= 2 && idx === 2) el.classList.add('ready'); else el.classList.remove('ready');
                });
            }

            function getWeekStartKey(date) {
                const d = new Date(date);
                const day = (d.getDay() + 6) % 7;
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() - day);
                return formatDate(d);
            }

            function ensureWeeklyReset() {
                const currentKey = getWeekStartKey(new Date());
                if (appState.progress.weekStartKey !== currentKey) {
                    appState.progress.weekStartKey = currentKey;
                    appState.progress.weeklyXP = 0;
                    appState.progress.weeklyStars = 0;
                }
            }

            function updateRedeemControls() {
                const redeemBtn = document.getElementById('redeemBtn');
                const canRedeem = (appState.progress.starBank || 0) >= 3 && appState.rewardPlan && appState.rewardPlan.description;
                if (redeemBtn) {
                    redeemBtn.disabled = !canRedeem;
                    redeemBtn.title = canRedeem ? '' : 'Нужно 3 ⭐ и запланированная награда';
                    // Ensure button is clickable for viewer role
                    if (appState.role === 'viewer') {
                        redeemBtn.style.pointerEvents = '';
                        redeemBtn.style.opacity = '';
                    }
                }
                const planned = document.getElementById('plannedRewardDisplay');
                if (planned) planned.textContent = appState.rewardPlan && appState.rewardPlan.description ? appState.rewardPlan.description : '—';
                const confirmBtn = document.getElementById('confirmRedeemBtn');
                if (confirmBtn) confirmBtn.disabled = !canRedeem;

                // Toggle idea button availability and planned card visibility
                const ideaBtn = document.getElementById('ideaBtn');
                const hasPlanned = !!(appState.rewardPlan && appState.rewardPlan.description);
                if (ideaBtn) {
                    ideaBtn.disabled = hasPlanned;
                    ideaBtn.title = hasPlanned ? 'Награда уже запланирована. Получите её, чтобы запланировать новую.' : 'Придумать и сохранить награду';
                }
                const plannedCard = document.getElementById('plannedRewardCard');
                const plannedText = document.getElementById('plannedRewardText');
                if (plannedCard) plannedCard.style.display = hasPlanned ? 'block' : 'none';
                if (plannedText) plannedText.textContent = hasPlanned ? appState.rewardPlan.description : '—';

                // Bank stars visualization (global goal: 3 ⭐ to redeem)
                const bank = Math.max(0, appState.progress.starBank || 0);
                const bankStars = [document.getElementById('bankStar1'), document.getElementById('bankStar2'), document.getElementById('bankStar3')];
                bankStars.forEach((el, idx) => { if (!el) return; if (idx < Math.min(3, bank)) el.classList.add('filled'); else el.classList.remove('filled'); if (bank >= 3) el.classList.add('ready'); else el.classList.remove('ready'); });
                const bankText = document.getElementById('bankStarsText');
                if (bankText) bankText.textContent = `${bank} ⭐`;
            }

            function renderWeeklyChart(weekStartOverride) {
                const container = document.getElementById('weeklyChart');
                if (!container) return;
                // Collect XP per day for selected week (Mon..Sun)
                const weekStart = weekStartOverride || getWeekStartFromOffset(appState.progressView?.weekOffset || 0);
                const days = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    return d;
                });
                const xpByDay = days.map(d => {
                    const key = formatDate(d);
                    const logs = appState.activityData[key] || [];
                    return logs.reduce((s, l) => s + (l.xpEarned || 0), 0);
                });
                const maxXP = Math.max(100, ...xpByDay);
                const dayLabels = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
                container.innerHTML = days.map((d, idx) => {
                    const val = xpByDay[idx];
                    const h = Math.round((val / maxXP) * 100);
                    return `
                        <div class="bar" title="${dayLabels[idx]}: ${val} XP">
                            <div class="bar-column" aria-label="${dayLabels[idx]} ${val} XP">
                                <div class="bar-value" style="height: ${h}%"></div>
                            </div>
                            <div class="bar-xp">${val}</div>
                            <div class="bar-label">${dayLabels[idx]}</div>
                        </div>
                    `;
                }).join('');
            }

            function getWeekStartFromOffset(offset) {
                const base = new Date();
                const day = (base.getDay() + 6) % 7; // 0=Mon
                base.setHours(0,0,0,0);
                base.setDate(base.getDate() - day + (offset * 7));
                return base;
            }

            function formatWeekRangeLabel(weekStart) {
                const end = new Date(weekStart);
                end.setDate(end.getDate() + 6);
                const fmt = (d) => d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
                const y = weekStart.getFullYear() === end.getFullYear() ? '' : ` ${end.getFullYear()}`;
                return `${fmt(weekStart)} – ${fmt(end)}${y}`;
            }

            function computeWeekXP(weekStart) {
                let total = 0;
                for (let i=0;i<7;i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate()+i);
                    const key = formatDate(d);
                    const logs = appState.activityData[key] || [];
                    total += logs.reduce((s,l)=>s+(l.xpEarned||0),0);
                }
                return total;
            }

            function updateProgressWeekSection() {
                const offset = appState.progressView?.weekOffset || 0;
                const start = getWeekStartFromOffset(offset);
                const label = document.getElementById('weekRangeLabel');
                if (label) label.textContent = formatWeekRangeLabel(start);
                const weekXP = computeWeekXP(start);
                const weeklyProgressPct = calculateXPProgress(weekXP, 750);
                const weeklyBar = document.getElementById('weeklyBar');
                if (weeklyBar) weeklyBar.style.width = `${weeklyProgressPct}%`;
                const weeklyText = document.getElementById('weeklyProgress');
                if (weeklyText) weeklyText.textContent = `${weekXP} / 750 XP`;
                // Update threshold markers
                const m500 = document.getElementById('marker500');
                const m750 = document.getElementById('marker750');
                if (m500) m500.classList.toggle('active', weekXP >= 500);
                if (m750) m750.classList.toggle('active', weekXP >= 750);
                updateWeeklyStarsDisplayForXP(weekXP);
                renderWeeklyChart(start);
                updateWeekNavControls();
            }

            function updateWeekNavControls() {
                const nextBtn = document.getElementById('weekNextBtn');
                if (nextBtn) nextBtn.disabled = (appState.progressView?.weekOffset || 0) >= 0;
            }

            function changeWeek(direction) {
                const newOffset = (appState.progressView?.weekOffset || 0) + direction;
                if (newOffset > 0) return; // prevent going to future
                appState.progressView.weekOffset = newOffset;
                updateProgressWeekSection();
                saveState();
            }

            function updateWeeklyStarsDisplayForXP(weeklyXP) {
                const stars = document.querySelectorAll('#weeklyStars .star');
                const count = calculateWeeklyStars(weeklyXP);
                stars.forEach((star, index) => {
                    if (index < count) star.classList.add('filled'); else star.classList.remove('filled');
                });
                const redeemStars = document.querySelectorAll('#redeemStars .redeem-star');
                redeemStars.forEach((el, idx) => {
                    if (idx < count) el.classList.add('filled'); else el.classList.remove('filled');
                    if (count >= 2 && idx === 2) el.classList.add('ready'); else el.classList.remove('ready');
                });
            }

            function updateMonthlyProgressSection() {
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 1);
                const daysInMonth = Math.round((nextMonth - monthStart)/(24*60*60*1000));
                let monthXP = 0;
                const xpByDay = [];
                for (let i=0;i<daysInMonth;i++) {
                    const d = new Date(monthStart);
                    d.setDate(monthStart.getDate()+i);
                    const key = formatDate(d);
                    const logs = appState.activityData[key] || [];
                    const dayXP = logs.reduce((s,l)=>s+(l.xpEarned||0),0);
                    xpByDay.push(dayXP);
                    monthXP += dayXP;
                }
                const pct = Math.min(100, Math.round((monthXP / 3000) * 100));
                const bar = document.getElementById('monthlyBar');
                if (bar) bar.style.width = `${pct}%`;
                const text = document.getElementById('monthlyProgressText');
                if (text) text.textContent = `${monthXP} / 3000 XP`;
                renderMonthlyInlineChart(monthStart, xpByDay);
            }

            function renderMonthlyInlineChart(monthStart, xpByDay) {
                const container = document.getElementById('monthlyInlineChart');
                if (!container) return;
                const max = Math.max(50, ...xpByDay);
                const days = xpByDay.length;
                container.innerHTML = Array.from({length: days}).map((_,i)=>{
                    const val = xpByDay[i];
                    const d = new Date(monthStart);
                    d.setDate(monthStart.getDate()+i);
                    const h = Math.round((val/max)*100);
                    return `
                        <div class=\"bar\" title=\"${d.toLocaleDateString('ru-RU')}: ${val} XP\">
                            <div class=\"bar-column\" aria-label=\"${val} XP\">
                                <div class=\"bar-value\" style=\"height:${h}%\"></div>
                            </div>
                            <div class=\"bar-xp\" style=\"font-size:0.7rem\">${val}</div>
                            <div class=\"bar-label\" style=\"font-size:0.65rem\">${i+1}</div>
                        </div>
                    `;
                }).join('');
            }

            function renderTasks() {
                const taskList = document.getElementById("taskList");
                taskList.innerHTML = appState.tasks
                    .map(
                        (task) => `
                <div class="task-item">
                    <div class="task-info" onclick="completeTask(event, ${task.id})" onkeydown="if(event.key==='Enter'||event.key===' '){completeTask(event, ${task.id})}" role="button" tabindex="0" style="flex: 1; cursor: pointer;">
                        <div class="task-icon">
                            <i class="${task.icon}"></i>
                        </div>
                        <div class="task-details">
                            <h4>${escapeHTML(task.name)}</h4>
                            <p>${escapeHTML(task.description)} • ${task.duration} мин</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="task-reward">
                            <i class="fas fa-star" style="color: #fbbf24;"></i>
                            +${task.xpReward} XP
                        </div>
                        <button class="btn-icon-delete" onclick="deleteTask(${task.id})" title="Удалить задание" aria-label="Удалить задание">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            function renderRewards() {
                const rewardsList = document.getElementById("rewardsList");

                if (appState.rewards.length === 0) {
                    rewardsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748b; font-size: 0.875rem;">
                        Пока нет полученных наград
                    </div>
                `;
                    return;
                }

                const cards = appState.rewards.slice(-9).reverse().map(reward => `
                    <div class="reward-card" title="${new Date(reward.redeemedAt).toLocaleDateString('ru-RU')}">
                        <div class="rc-top">
                            <span class="reward-chip"><i class="fas fa-star"></i> -${reward.starsUsed} ⭐</span>
                            <i class="fas fa-gift" style="color:#1e40af;"></i>
                        </div>
                        <div class="reward-title">${escapeHTML(reward.description)}</div>
                        <div class="reward-date-2">${new Date(reward.redeemedAt).toLocaleDateString('ru-RU')}</div>
                    </div>
                `).join('');
                rewardsList.innerHTML = `<div class="rewards-grid">${cards}</div>`;
            }

            function clearRewards() {
                if (confirm('Удалить ВСЕ сохраненные награды?')) {
                    appState.rewards = [];
                    renderRewards();
                    showNotification('Все награды удалены', 'info');
                    saveState();
                }
            }

            function generateCalendar() {
                const calendar = document.getElementById("calendar");
                const monthTitle = document.getElementById("monthTitle");

                const currentMonth = appState.currentMonth;
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();

                const monthNames = [
                    "Январь",
                    "Февраль",
                    "Март",
                    "Апрель",
                    "Май",
                    "Июнь",
                    "Июль",
                    "Август",
                    "Сентябрь",
                    "Октябрь",
                    "Ноябрь",
                    "Декабрь",
                ];

                monthTitle.textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = new Date(firstDay);
                startDay.setDate(
                    startDay.getDate() - ((firstDay.getDay() + 6) % 7),
                );

                const today = new Date();
                const selectedDate = appState.selectedDate;

                let days = "";
                let currentDay = new Date(startDay);

                for (let i = 0; i < 42; i++) {
                    const dayStr = formatDate(currentDay);
                    const isCurrentMonth = currentDay.getMonth() === month;
                    const isToday =
                        formatDate(currentDay) === formatDate(today);
                    const isSelected =
                        formatDate(currentDay) === formatDate(selectedDate);
                    const hasActivity = appState.activityData[dayStr];

                    let classes = "calendar-day";
                    if (isToday) classes += " today";
                    if (isSelected) classes += " selected";
                    if (hasActivity) classes += " active";
                    if (!isCurrentMonth) classes += " other-month";

                    days += `
                    <div class="${classes}" onclick="selectDate('${dayStr}')">
                        ${currentDay.getDate()}
                    </div>
                `;

                    currentDay.setDate(currentDay.getDate() + 1);
                }

                calendar.innerHTML = days;
            }

            function updateDayActivity() {
                const selectedDateStr = formatDate(appState.selectedDate);
                const dayActivity = document.getElementById("dayActivity");
                const selectedDateTitle =
                    document.getElementById("selectedDateTitle");

                const dateStr =
                    appState.selectedDate.toLocaleDateString("ru-RU");
                selectedDateTitle.textContent = `Активность за ${dateStr}`;

                const activity = appState.activityData[selectedDateStr];
                if (activity && activity.length > 0) {
                    const totalXP = activity.reduce(
                        (sum, log) => sum + log.xpEarned,
                        0,
                    );
                    dayActivity.innerHTML = `
                    <div style="color: #059669; font-weight: 600;">
                        Выполнено заданий: ${activity.length} • Получено XP: +${totalXP}
                    </div>
                    <div style="margin-top: 8px;">
                        ${activity
                            .map(
                                (log, index) => `
                            <div class="activity-item" data-date="${selectedDateStr}" data-index="${index}">
                                ${escapeHTML(log.taskName)} (+${log.xpEarned} XP)
                                <button class="activity-delete" onclick="deleteActivity('${selectedDateStr}', ${index})" title="Удалить запись активности" aria-label="Удалить запись активности">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `,
                            )
                            .join("")}
                    </div>
                `;
                } else {
                    dayActivity.innerHTML = `
                    <div style="color: #64748b;">
                        Пока нет активности за выбранный день
                    </div>
                `;
                }
            }

            // Event Handlers
            function completeTask(e, taskId) {
                if (appState.role === 'viewer') { showNotification('Режим просмотра: действие недоступно', 'info'); return; }
                const task = appState.tasks.find((t) => t.id === taskId);
                if (!task) return;

                // Animate task completion
                const taskElement = e.currentTarget.closest('.task-item');
                taskElement.classList.add("task-completed");

                setTimeout(() => {
                    ensureWeeklyReset();
                    // Update progress
                    appState.progress.totalXP += task.xpReward;
                    appState.progress.currentLevelXP += task.xpReward;
                    appState.progress.weeklyXP += task.xpReward;

                    // Check for level up
                    let xpNeeded = getXPRequiredForLevel(appState.progress.level);
                    let leveledUp = false;
                    while (xpNeeded > 0 && appState.progress.currentLevelXP >= xpNeeded && appState.progress.level < 100) {
                        appState.progress.currentLevelXP -= xpNeeded;
                        appState.progress.level += 1;
                        leveledUp = true;
                        xpNeeded = getXPRequiredForLevel(appState.progress.level);
                    }
                    if (appState.progress.level >= 100) {
                        appState.progress.level = 100;
                        appState.progress.currentLevelXP = 0;
                    }

                    if (leveledUp) {
                        showNotification(
                            `Поздравляем! Вы достигли ${appState.progress.level} уровня!`,
                            "success",
                        );
                        document.getElementById("currentLevel").classList.add("level-up");
                        setTimeout(() => {
                            document.getElementById("currentLevel").classList.remove("level-up");
                        }, 1000);
                    } else {
                        showNotification(`Задание выполнено! +${task.xpReward} XP`, "success");
                    }

                    // Log activity
                    const today = formatDate(new Date());
                    if (!appState.activityData[today]) {
                        appState.activityData[today] = [];
                    }
                    appState.activityData[today].push({
                        taskId: task.id,
                        taskName: task.name,
                        xpEarned: task.xpReward,
                        completedAt: new Date(),
                    });

                    // Update displays
                    updateProgressDisplay();
                    generateCalendar();
                    updateDayActivity();
                    renderWeeklyChart();
                    saveState();

                    taskElement.classList.remove("task-completed");
                }, 600);
            }

            function addTask(event) {
                event.preventDefault();

                const name = document.getElementById("taskName").value;
                const description =
                    document.getElementById("taskDescription").value;
                let xpReward = parseInt(
                    document.getElementById("taskXP").value, 10
                );
                let duration = parseInt(
                    document.getElementById("taskDuration").value, 10
                );

                // Если поле Название задания содержит специальную команду очистки
                if (name.trim().toLowerCase() === 'очистить' || name.trim().toLowerCase() === 'clear') {
                    if (confirm('Очистить все сохраненные задания?')) {
                        appState.tasks = [];
                        renderTasks();
                        showNotification('Все задания очищены', 'info');
                        saveState();
                    }
                    document.getElementById("taskForm").reset();
                    return;
                }

                if (Number.isNaN(xpReward)) xpReward = 50;
                if (Number.isNaN(duration)) duration = 15;
                xpReward = Math.min(500, Math.max(10, xpReward));
                duration = Math.min(120, Math.max(5, duration));

                const newTask = {
                    id: Date.now(),
                    name,
                    description,
                    xpReward,
                    duration,
                    icon: getSelectedIcon(),
                    category: "custom",
                };

                appState.tasks.push(newTask);
                renderTasks();
                hideTaskModal();
                showNotification("Новое задание добавлено!", "success");
                saveState();

                // Reset form
                document.getElementById("taskForm").reset();
                renderWeeklyChart();
            }

            function addReward(event) {
                event.preventDefault();

                const starsCost = 3;
                const planned = appState.rewardPlan && appState.rewardPlan.description;
                if (!planned) {
                    showNotification('Сначала придумайте награду', 'warning');
                    return;
                }
                if ((appState.progress.starBank || 0) < starsCost) {
                    showNotification('Недостаточно звезд для получения награды!', 'error');
                    return;
                }

                const newReward = {
                    id: Date.now(),
                    description: planned,
                    starsUsed: starsCost,
                    redeemedAt: new Date(),
                };

                appState.rewards.push(newReward);
                appState.progress.starBank -= starsCost;
                appState.rewardPlan = { description: "" };

                renderRewards();
                updateWeeklyStars();
                hideRewardModal();
                showNotification("Награда получена!", "success");
                saveState();

                // Reset form
                document.getElementById("rewardForm").reset();
                updateRedeemControls();
            }

            function selectDate(dateStr) {
                appState.selectedDate = new Date(dateStr);
                generateCalendar();
                updateDayActivity();
                saveState();
                renderWeeklyChart();
            }

            function changeMonth(direction) {
                appState.currentMonth = new Date(
                    appState.currentMonth.getFullYear(),
                    appState.currentMonth.getMonth() + direction,
                    1,
                );
                generateCalendar();
                saveState();
                renderWeeklyChart();
            }

            // Icon Functions
            function populateIconSelector() {
                const selector = document.getElementById('iconSelector');
                if (!selector) return;
                
                selector.innerHTML = availableIcons.map((icon, index) => `
                    <div class="icon-option ${index === 0 ? 'selected' : ''}" 
                         onclick="selectIcon(${index})" 
                         title="${icon.name}"
                         data-icon="${icon.class}">
                        <i class="${icon.class}"></i>
                    </div>
                `).join('');
            }

            function selectIcon(index) {
                // Remove selected class from all options
                document.querySelectorAll('.icon-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                const selectedOption = document.querySelectorAll('.icon-option')[index];
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }

            function getSelectedIcon() {
                const selectedOption = document.querySelector('.icon-option.selected');
                return selectedOption ? selectedOption.getAttribute('data-icon') : 'fas fa-book';
            }

            // Modal Functions
            function showTaskModal() {
                document.getElementById("taskModal").classList.add("show");
                populateIconSelector(); // Populate icons when modal opens
            }

            function hideTaskModal() {
                document.getElementById("taskModal").classList.remove("show");
                // Reset icon selection to first icon
                setTimeout(() => {
                    const firstIcon = document.querySelector('.icon-option');
                    if (firstIcon) {
                        document.querySelectorAll('.icon-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        firstIcon.classList.add('selected');
                    }
                }, 100);
            }

            function showRewardModal() {
                updateRedeemControls();
                if (!appState.rewardPlan || !appState.rewardPlan.description) {
                    // Если награда не запланирована — сразу просим придумать
                    showIdeaModal();
                    return;
                }
                if ((appState.progress.starBank || 0) < 3) {
                    showNotification('Недостаточно звезд (нужно 3 ⭐)', 'info');
                }
                const planned = document.getElementById('plannedRewardDisplay');
                if (planned) planned.textContent = appState.rewardPlan.description || '—';
                const availableStarsEl = document.getElementById('availableStars');
                if (availableStarsEl) availableStarsEl.textContent = `${appState.progress.starBank || 0} ⭐`;
                const confirmBtn = document.getElementById('confirmRedeemBtn');
                if (confirmBtn) confirmBtn.disabled = (appState.progress.starBank || 0) < 3;
                document.getElementById("rewardModal").classList.add("show");
            }
            // Idea Modal
            function showIdeaModal() {
                // Блокируем повторное придумывание, если уже есть запланированная награда
                if (appState.rewardPlan && appState.rewardPlan.description) {
                    showNotification('Награда уже запланирована. Сначала получите её, чтобы придумать новую.', 'info');
                    return;
                }
                document.getElementById('ideaModal').classList.add('show');
                const input = document.getElementById('ideaDescription');
                if (input) {
                    renderIdeaSuggestions(input.value || '');
                    input.focus();
                }
            }
            function hideIdeaModal() {
                document.getElementById('ideaModal').classList.remove('show');
                const box = document.getElementById('ideaAutocomplete');
                if (box) { box.style.display = 'none'; box.innerHTML = ''; }
            }
            function saveRewardIdea(event) {
                event.preventDefault();
                const desc = document.getElementById('ideaDescription').value.trim();
                if (!desc) return;
                const cmd = desc.toLowerCase();
                if (cmd === 'очистить' || cmd === 'clear') {
                    if (confirm('Удалить ВСЕ сохраненные награды?')) {
                        appState.rewards = [];
                        renderRewards();
                        showNotification('Все награды очищены', 'info');
                        saveState();
                    }
                    document.getElementById('ideaForm').reset();
                    hideIdeaModal();
                    updateRedeemControls();
                    return;
                }
                appState.rewardPlan = { description: desc };
                addIdea(desc);
                hideIdeaModal();
                updateRedeemControls();
                showNotification('Награда сохранена!', 'success');
                saveState();
                document.getElementById('ideaForm').reset();
            }

            function hideRewardModal() {
                document.getElementById("rewardModal").classList.remove("show");
            }

            // Initialize Application
            function initApp() {
                loadState();
                ensureWeeklyReset();

                // Add some demo activity only if none exists
                const hasAnyActivity = Object.keys(appState.activityData || {}).length > 0;
                if (!hasAnyActivity) {
                    if (!appState.resetDate) appState.resetDate = new Date();
                    const today = formatDate(new Date());
                    const yesterday = formatDate(new Date(Date.now() - 86400000));

                    appState.activityData[today] = [
                        {
                            taskId: 1,
                            taskName: "Изучение новых слов",
                            xpEarned: 50,
                            completedAt: new Date(),
                        },
                    ];

                    appState.activityData[yesterday] = [
                        {
                            taskId: 2,
                            taskName: "Грамматические упражнения",
                            xpEarned: 75,
                            completedAt: new Date(Date.now() - 86400000),
                        },
                        {
                            taskId: 3,
                            taskName: "Аудирование",
                            xpEarned: 60,
                            completedAt: new Date(Date.now() - 86400000),
                        },
                    ];
                }

                // Force account selection (always show on load, default viewer)
                if (!appState.role) appState.role = 'viewer';
                document.getElementById('accountModal').classList.add('show');

                updateProgressDisplay();
                renderTasks();
                renderRewards();
                generateCalendar();
                updateDayActivity();
                renderWeeklyChart();
                updateRedeemControls();
                populateIconSelector(); // Initialize icon selector
                if (appState.role === 'viewer') showWelcomeModal();
                applyRolePermissions();
            }

            // Delete Task Function
            function deleteTask(taskId) {
                if (confirm('Вы уверены, что хотите удалить это задание?')) {
                    appState.tasks = appState.tasks.filter(task => task.id !== taskId);
                    renderTasks();
                    showNotification('Задание удалено', 'info');
                    saveState();
                }
            }

            // Delete Activity Function with full state recalculation
            function deleteActivity(dateStr, index) {
                if (appState.role === 'viewer') { showNotification('Режим просмотра: действие недоступно', 'info'); return; }
                if (!confirm('Удалить эту запись активности? Это повлияет на ваш прогресс.')) {
                    return;
                }

                const activity = appState.activityData[dateStr];
                if (!activity || !activity[index]) return;

                const deletedLog = activity[index];
                const deletedXP = deletedLog.xpEarned;

                // Remove the activity log
                activity.splice(index, 1);
                if (activity.length === 0) {
                    delete appState.activityData[dateStr];
                }

                // Recalculate all progress from scratch
                recalculateAllProgress();

                // Update all displays
                updateProgressDisplay();
                generateCalendar();
                updateDayActivity();
                renderWeeklyChart();
                updateRedeemControls();
                saveState();

                showNotification(`Активность удалена (-${deletedXP} XP)`, 'info');
            }

            // Recalculate all progress from activity data
            function recalculateAllProgress() {
                // Reset progress to base values
                appState.progress.totalXP = 0;
                appState.progress.level = 1;
                appState.progress.currentLevelXP = 0;
                appState.progress.weeklyXP = 0;
                appState.progress.weeklyStars = 0;
                appState.progress.starBank = 0;

                // Get all activity dates sorted chronologically
                const dates = Object.keys(appState.activityData).sort();
                
                // Track weekly progress by week start key
                const weeklyData = {};
                let totalXP = 0;

                for (const dateStr of dates) {
                    const logs = appState.activityData[dateStr];
                    if (!Array.isArray(logs)) continue;

                    const dayXP = logs.reduce((sum, log) => sum + (log.xpEarned || 0), 0);
                    totalXP += dayXP;

                    // Track weekly XP
                    const weekKey = getWeekStartKey(new Date(dateStr));
                    if (!weeklyData[weekKey]) weeklyData[weekKey] = 0;
                    weeklyData[weekKey] += dayXP;
                }

                // Set total XP and calculate level
                appState.progress.totalXP = totalXP;
                
                // Calculate level from total XP (810 XP per level)
                const xpPerLevel = 810;
                appState.progress.level = Math.min(100, Math.floor(totalXP / xpPerLevel) + 1);
                appState.progress.currentLevelXP = totalXP % xpPerLevel;
                
                // If at max level, set currentLevelXP to 0
                if (appState.progress.level >= 100) {
                    appState.progress.level = 100;
                    appState.progress.currentLevelXP = 0;
                }

                // Calculate current week progress
                const currentWeekKey = getWeekStartKey(new Date());
                appState.progress.weeklyXP = weeklyData[currentWeekKey] || 0;
                appState.progress.weekStartKey = currentWeekKey;

                // Calculate stars earned this week and transfer to star bank
                const weeklyStars = calculateWeeklyStars(appState.progress.weeklyXP);
                appState.progress.weeklyStars = weeklyStars;

                // Calculate total star bank from all weeks
                let totalStars = 0;
                for (const weekKey in weeklyData) {
                    const weekXP = weeklyData[weekKey];
                    totalStars += calculateWeeklyStars(weekXP);
                }
                appState.progress.starBank = Math.max(0, totalStars - (appState.rewards.length * 3));
            }

            function clearTasks() {
                if (confirm('Удалить ВСЕ сохраненные задания?')) {
                    appState.tasks = [];
                    renderTasks();
                    showNotification('Все задания удалены', 'info');
                    saveState();
                }
            }

            // Settings Functions
            function toggleSettingsMenu() {
                const menu = document.getElementById('settingsMenu');
                menu.classList.toggle('show');
                const btn = document.querySelector('.settings-btn');
                if (btn) btn.setAttribute('aria-expanded', menu.classList.contains('show') ? 'true' : 'false');
            }

            

            function applyStateFromBase64(b64) {
                try {
                    const json = decodeURIComponent(escape(atob(b64)));
                    const incoming = JSON.parse(json);
                    if (!incoming || !incoming.progress || !incoming.tasks) throw new Error('bad payload');
                    appState.progress = { ...appState.progress, ...incoming.progress };
                    appState.tasks = incoming.tasks || appState.tasks;
                    appState.rewards = incoming.rewards || [];
                    appState.activityData = incoming.activityData || {};
                    appState.rewardPlan = incoming.rewardPlan || { description: '' };
                    appState.resetDate = incoming.resetDate ? new Date(incoming.resetDate) : (appState.resetDate || new Date());
                    updateProgressDisplay(); renderTasks(); renderRewards(); generateCalendar(); updateDayActivity(); renderWeeklyChart(); updateRedeemControls(); saveState();
                    showNotification('Состояние синхронизировано', 'success');
                } catch (e) {
                    showNotification('Ошибка применения состояния', 'error');
                }
            }

            

            function openDriveHelp() {
                alert('Google Drive: используйте Экспорт для сохранения файла в приложение Drive, а затем на втором устройстве – Импорт, выбрав файл из Drive. Это офлайн-дружественный ручной способ.');
            }





            function exportData() {
                const dataToExport = {
                    progress: appState.progress,
                    tasks: appState.tasks,
                    rewards: appState.rewards,
                    activityData: appState.activityData,
                    rewardPlan: appState.rewardPlan,
                    resetDate: appState.resetDate,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `english-learning-progress-${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Данные экспортированы успешно!', 'success');
                toggleSettingsMenu();
            }

            // File System Access API: save/load snapshots to a user-selected index file
            async function saveToFileIndex() {
                if (!('showSaveFilePicker' in window)) { showNotification('Браузер не поддерживает сохранение в файл-индекс', 'error'); return; }
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: 'english-learning-index.json', types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
                    const existing = await readJsonFromHandle(handle, []);
                    const snapshot = buildSnapshot();
                    existing.push(snapshot);
                    await writeJsonToHandle(handle, existing);
                    showNotification('Слепок сохранен в файл-индекс', 'success');
                } catch (e) {
                    // user cancelled or error
                }
            }
            async function loadFromFileIndex() {
                if (!('showOpenFilePicker' in window)) { showNotification('Браузер не поддерживает загрузку из файл-индекса', 'error'); return; }
                try {
                    const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
                    const list = await readJsonFromHandle(handle, []);
                    if (!Array.isArray(list) || list.length === 0) { showNotification('Файл-индекс пуст', 'info'); return; }
                    renderSnapshotPicker(list, (snap) => { applyImportedSnapshot(snap); hideSnapshotPickerModal(); });
                } catch (e) {
                    // cancelled
                }
            }
            function buildSnapshot() {
                return {
                    id: Date.now(),
                    title: `Слепок от ${new Date().toLocaleString('ru-RU')}`,
                    createdAt: new Date().toISOString(),
                    data: {
                        progress: appState.progress,
                        tasks: appState.tasks,
                        rewards: appState.rewards,
                        activityData: appState.activityData,
                        rewardPlan: appState.rewardPlan,
                        resetDate: appState.resetDate,
                        version: '1.0'
                    }
                };
            }
            async function readJsonFromHandle(handle, fallback) {
                try { const file = await handle.getFile(); const text = await file.text(); return JSON.parse(text); } catch { return fallback; }
            }
            async function writeJsonToHandle(handle, obj) {
                const writable = await handle.createWritable();
                await writable.write(new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }));
                await writable.close();
            }
            function renderSnapshotPicker(list, onPick) {
                const modal = document.getElementById('snapshotPickerModal');
                const box = document.getElementById('snapshotList');
                if (!modal || !box) return;
                box.innerHTML = list.slice().reverse().map(s => `
                    <div class=\"reward-card\" style=\"margin-bottom:8px;\">
                        <div class=\"rc-top\"><div class=\"reward-title\">${escapeHTML(s.title || ('Слепок #' + s.id))}</div><div class=\"reward-date-2\">${new Date(s.createdAt).toLocaleString('ru-RU')}</div></div>
                        <div style=\"display:flex; gap:8px; justify-content:flex-end; margin-top:6px;\">
                            <button class=\"btn btn-secondary\" data-id=\"${s.id}\"><i class=\"fas fa-eye\"></i> Просмотр</button>
                            <button class=\"btn btn-primary\" data-apply=\"${s.id}\"><i class=\"fas fa-check\"></i> Применить</button>
                        </div>
                    </div>
                `).join('');
                box.querySelectorAll('[data-apply]').forEach(btn => btn.addEventListener('click', () => {
                    const id = Number(btn.getAttribute('data-apply'));
                    const found = list.find(x => x.id === id);
                    if (found) onPick(found.data);
                }));
                box.querySelectorAll('[data-id]').forEach(btn => btn.addEventListener('click', () => {
                    const id = Number(btn.getAttribute('data-id'));
                    const found = list.find(x => x.id === id);
                    if (found) alert(JSON.stringify(found.data, null, 2));
                }));
                modal.classList.add('show');
            }
            function hideSnapshotPickerModal() { const m = document.getElementById('snapshotPickerModal'); if (m) m.classList.remove('show'); }
            function applyImportedSnapshot(importedData) {
                if (!importedData || !importedData.progress || !importedData.tasks) { showNotification('Некорректный слепок', 'error'); return; }
                appState.progress = { ...appState.progress, ...importedData.progress };
                appState.tasks = importedData.tasks || appState.tasks;
                appState.rewards = importedData.rewards || [];
                appState.activityData = importedData.activityData || {};
                appState.rewardPlan = importedData.rewardPlan || { description: '' };
                appState.resetDate = importedData.resetDate ? new Date(importedData.resetDate) : (appState.resetDate || new Date());
                updateProgressDisplay(); renderTasks(); renderRewards(); generateCalendar(); updateDayActivity(); renderWeeklyChart(); updateRedeemControls(); saveState();
                showNotification('Слепок применен', 'success');
            }

            // Chart.js optional integration (loaded online) with fallback to existing DOM charts
            let analyticsCharts = [];
            async function tryLoadChartJs() {
                if (window.Chart && typeof window.Chart === 'function') return true;
                try {
                    await loadExternalScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js');
                    return !!window.Chart;
                } catch { return false; }
            }
            function destroyAnalyticsCharts() { analyticsCharts.forEach(ch => { try { ch.destroy(); } catch {} }); analyticsCharts = []; }
            function renderAnalyticsWithChartJS() {
                const ok = !!(window.Chart);
                if (!ok) return;
                // Example: comparison of last 4 weeks XP totals
                const weeks = [];
                const totals = [];
                for (let w = -3; w <= 0; w++) {
                    const start = getWeekStartFromOffset(w);
                    weeks.push(formatWeekRangeLabel(start));
                    totals.push(computeWeekXP(start));
                }
                const cv = document.getElementById('comparisonChartCanvas');
                if (cv) {
                    const ctx = cv.getContext('2d');
                    analyticsCharts.push(new Chart(ctx, {
                        type: 'bar',
                        data: { labels: weeks, datasets: [{ label: 'XP за неделю', data: totals, backgroundColor: '#3b82f6' }] },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    }));
                }
            }
            function loadExternalScript(src) {
                return new Promise((resolve, reject) => {
                    const s = document.createElement('script'); s.src = src; s.async = true; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
                });
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Validate imported data
                        if (!importedData.progress || !importedData.tasks) {
                            throw new Error('Недопустимый формат файла');
                        }

                        // Restore data
                        appState.progress = { ...appState.progress, ...importedData.progress };
                        appState.tasks = importedData.tasks || appState.tasks;
                        appState.rewards = importedData.rewards || [];
                        appState.activityData = importedData.activityData || {};
                        appState.rewardPlan = importedData.rewardPlan || { description: "" };
                        appState.resetDate = importedData.resetDate ? new Date(importedData.resetDate) : (appState.resetDate || new Date());

                        // Update UI
                        updateProgressDisplay();
                        renderTasks();
                        renderRewards();
                        generateCalendar();
                        updateDayActivity();
                        renderWeeklyChart();

                        showNotification('Данные импортированы успешно!', 'success');
                        saveState();
                    } catch (error) {
                        showNotification('Ошибка при импорте данных: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
                toggleSettingsMenu();
            }

            function resetProgress() {
                if (confirm('Вы уверены, что хотите сбросить весь прогресс? Это действие нельзя отменить!')) {
                    // Reset to initial state
                    appState.progress = {
                        level: 1,
                        totalXP: 0,
                        currentLevelXP: 0,
                        streak: 0,
                        weeklyXP: 0,
                        weeklyStars: 0
                    };
                    
                    appState.tasks = [
                        {
                            id: 1,
                            name: "Изучение новых слов",
                            description: "Выучить 10 новых английских слов",
                            xpReward: 50,
                            duration: 15,
                            icon: "fas fa-book",
                            category: "vocabulary",
                        },
                        {
                            id: 2,
                            name: "Грамматические упражнения",
                            description: "Выполнить упражнения на Present Simple",
                            xpReward: 75,
                            duration: 20,
                            icon: "fas fa-pencil-alt",
                            category: "grammar",
                        },
                        {
                            id: 3,
                            name: "Аудирование",
                            description: "Прослушать диалог и ответить на вопросы",
                            xpReward: 60,
                            duration: 25,
                            icon: "fas fa-headphones",
                            category: "listening",
                        }
                    ];
                    
                    appState.rewards = [];
                    appState.activityData = {};
                    appState.resetDate = new Date();

                    // Update UI
                    updateProgressDisplay();
                    renderTasks();
                    renderRewards();
                    generateCalendar();
                    updateDayActivity();
                    renderWeeklyChart();

                    showNotification('Прогресс сброшен!', 'info');
                    saveState();
                }
                toggleSettingsMenu();
            }

            // Close modals and menus on outside click
            window.onclick = function (event) {
                const taskModal = document.getElementById("taskModal");
                const rewardModal = document.getElementById("rewardModal");
                const ideaModal = document.getElementById("ideaModal");
                const analyticsModal = document.getElementById("analyticsModal");
                const settingsMenu = document.getElementById("settingsMenu");

                if (event.target === taskModal) {
                    hideTaskModal();
                }
                if (event.target === rewardModal) {
                    hideRewardModal();
                }
                if (event.target === ideaModal) {
                    hideIdeaModal();
                }
                if (event.target === analyticsModal) {
                    hideAnalyticsModal();
                }

                
                // Close settings menu if clicked outside
                if (!event.target.closest('.settings-panel')) {
                    settingsMenu.classList.remove('show');
                    const btn = document.querySelector('.settings-btn');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            };

            // Close menus/modals on Esc
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideTaskModal();
                    hideRewardModal();
                    hideIdeaModal();
                    hideAnalyticsModal();

                    const menu = document.getElementById('settingsMenu');
                    if (menu) menu.classList.remove('show');
                    const btn = document.querySelector('.settings-btn');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            });

            // Analytics Functions
            function showAnalyticsModal() {
                document.getElementById('analyticsModal').classList.add('show');
                // sync demo UI
                const badge = document.getElementById('demoBadge');
                const btn = document.getElementById('toggleDemoBtn');
                const enabled = !!(appState.demoAnalytics && appState.demoAnalytics.enabled);
                if (badge) badge.style.display = enabled ? 'inline-flex' : 'none';
                if (btn) btn.textContent = enabled ? 'Выключить демо' : 'Демо';
                calculateAnalytics();
                // Try Chart.js
                tryLoadChartJs().then((ok)=>{ if (ok) { destroyAnalyticsCharts(); renderAnalyticsWithChartJS(); } });
            }

            function hideAnalyticsModal() {
                document.getElementById('analyticsModal').classList.remove('show');
            }

            function switchAnalyticsTab(tabName) {
                // Remove active from all tabs and content
                document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active to clicked tab and corresponding content
                event.target.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                
                // Recalculate charts for active tab
                if (tabName === 'progress') renderProgressCharts();
                if (tabName === 'patterns') renderPatternCharts();
                if (tabName === 'achievements') renderAchievementCharts();
            }

            function calculateAnalytics() {
                const analytics = computeAnalyticsData();
                renderOverviewTab(analytics);
            }

            function computeAnalyticsData() {
                const state = getEffectiveState();
                const activity = state.activityData || {};
                const dates = Object.keys(activity).sort();
                
                // Basic stats
                const totalActiveDays = dates.length;
                const totalTasksCompleted = dates.reduce((sum, date) => {
                    return sum + (activity[date] ? activity[date].length : 0);
                }, 0);
                
                const totalXP = state.progress.totalXP;
                const avgXpPerDay = totalActiveDays > 0 ? Math.round(totalXP / totalActiveDays) : 0;
                
                // Best day
                let bestDayXP = 0;
                let bestDayDate = '';
                let bestDayTasks = 0;
                let maxDayTasks = 0;
                
                dates.forEach(date => {
                    const logs = activity[date] || [];
                    const dayXP = logs.reduce((sum, log) => sum + (log.xpEarned || 0), 0);
                    const dayTasks = logs.length;
                    
                    if (dayXP > bestDayXP) {
                        bestDayXP = dayXP;
                        bestDayDate = date;
                    }
                    if (dayTasks > maxDayTasks) {
                        maxDayTasks = dayTasks;
                    }
                });
                
                // Weekly data
                const weeklyData = {};
                dates.forEach(date => {
                    const weekKey = getWeekStartKey(new Date(date));
                    if (!weeklyData[weekKey]) weeklyData[weekKey] = { xp: 0, tasks: 0 };
                    const logs = activity[date] || [];
                    weeklyData[weekKey].xp += logs.reduce((sum, log) => sum + (log.xpEarned || 0), 0);
                    weeklyData[weekKey].tasks += logs.length;
                });
                
                const bestWeekXP = Math.max(0, ...Object.values(weeklyData).map(w => w.xp));
                
                // Stars calculation
                const totalStarsEarned = Object.values(weeklyData).reduce((sum, week) => {
                    return sum + calculateWeeklyStars(week.xp);
                }, 0);
                const starsSpent = (state.rewards?.length || 0) * 3;
                
                // Streak calculation
                const currentStreakData = getCurrentStreakData();
                const bestStreak = calculateBestStreak();
                const consistency = totalActiveDays > 0 ? Math.round((currentStreakData.studied / Math.max(1, currentStreakData.total)) * 100) : 0;
                
                // Weekday patterns
                const weekdayData = [0,0,0,0,0,0,0]; // Sun-Sat
                dates.forEach(date => {
                    const d = new Date(date);
                    const day = d.getDay();
                    const logs = activity[date] || [];
                    weekdayData[day] += logs.reduce((sum, log) => sum + (log.xpEarned || 0), 0);
                });
                
                const bestWeekdayIndex = weekdayData.indexOf(Math.max(...weekdayData));
                const weekdayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                const bestWeekday = weekdayNames[bestWeekdayIndex];
                
                // Growth calculation (last 4 weeks)
                const now = new Date();
                const fourWeeksAgo = new Date(now.getTime() - 28 * 24 * 60 * 60 * 1000);
                const recentXP = dates.filter(date => new Date(date) >= fourWeeksAgo)
                    .reduce((sum, date) => {
                        const logs = activity[date] || [];
                        return sum + logs.reduce((s, log) => s + (log.xpEarned || 0), 0);
                    }, 0);
                
                // Predictions
                const avgXpPerWeek = totalActiveDays > 0 ? (totalXP / (totalActiveDays / 7)) : 0;
                const xpToMaxLevel = (100 - state.progress.level) * 810;
                const weeksToMax = avgXpPerWeek > 0 ? Math.ceil(xpToMaxLevel / avgXpPerWeek) : '∞';
                
                const currentWeekXP = state.progress.weeklyXP;
                const nextStarXP = currentWeekXP >= 750 ? 'Все звезды получены' : 
                                  currentWeekXP >= 500 ? `${750 - currentWeekXP} XP` : `${500 - currentWeekXP} XP`;
                
                return {
                    totalActiveDays,
                    totalTasksCompleted,
                    avgXpPerDay,
                    bestDayXP,
                    bestDayDate,
                    maxDayTasks,
                    bestWeekXP,
                    totalStarsEarned,
                    starsSpent,
                    currentStreak: currentStreakData,
                    bestStreak,
                    consistency,
                    bestWeekday,
                    recentXP,
                    weeksToMax,
                    nextStarXP,
                    weeklyData,
                    weekdayData
                };
            }

            function getCurrentStreakData() {
                const state = getEffectiveState();
                const start = new Date(state.resetDate || new Date());
                const today = new Date();
                let studied = 0;
                let totalEligible = 0;
                iterateDays(start, today, (d) => {
                    if (isWeekday(d)) {
                        totalEligible += 1;
                        if (hasActivityOn(d, state)) studied += 1;
                    }
                });
                return { studied, total: totalEligible };
            }

            function calculateBestStreak() {
                const state = getEffectiveState();
                const activity = state.activityData || {};
                const dates = Object.keys(activity).sort();
                if (dates.length === 0) return 0;
                
                let maxStreak = 0;
                let currentStreak = 0;
                let lastDate = null;
                
                dates.forEach(dateStr => {
                    const currentDate = new Date(dateStr);
                    if (lastDate) {
                        const daysDiff = Math.round((currentDate - lastDate) / (24 * 60 * 60 * 1000));
                        if (daysDiff === 1) {
                            currentStreak++;
                        } else {
                            currentStreak = 1;
                        }
                    } else {
                        currentStreak = 1;
                    }
                    maxStreak = Math.max(maxStreak, currentStreak);
                    lastDate = currentDate;
                });
                
                return maxStreak;
            }

            function renderOverviewTab(analytics) {
                const state = getEffectiveState();
                // Total stats
                document.getElementById('totalActiveDays').textContent = analytics.totalActiveDays;
                document.getElementById('totalTasksCompleted').textContent = analytics.totalTasksCompleted;
                document.getElementById('avgXpPerDay').textContent = analytics.avgXpPerDay + ' XP';
                document.getElementById('bestDay').textContent = `${analytics.bestDayXP} XP`;
                
                // Level progress ring
                const levelProgress = (state.progress.currentLevelXP / 810) * 100;
                const circumference = 2 * Math.PI * 52;
                const fillLength = (levelProgress / 100) * circumference;
                document.getElementById('levelRingFill').style.strokeDasharray = `${fillLength} ${circumference}`;
                document.getElementById('levelRingText').textContent = `Lv.${state.progress.level}`;
                
                // Streak stats
                document.getElementById('currentStreakStat').textContent = `${analytics.currentStreak.studied}/${analytics.currentStreak.total}`;
                document.getElementById('bestStreak').textContent = `${analytics.bestStreak} дней`;
                document.getElementById('consistency').textContent = `${analytics.consistency}%`;
                
                // Stars and rewards
                document.getElementById('totalStarsEarned').textContent = analytics.totalStarsEarned;
                document.getElementById('starsSpent').textContent = analytics.starsSpent;
                document.getElementById('rewardsCount').textContent = (state.rewards?.length || 0);
                
                // Weekly trend chart (simplified)
                renderWeeklyTrendChart(analytics.weeklyData);
            }

            function renderWeeklyTrendChart(weeklyData) {
                const container = document.getElementById('weeklyTrendChart');
                if (!container) return;
                
                const weeks = Object.keys(weeklyData).sort().slice(-12); // Last 12 weeks
                const maxXP = Math.max(100, ...weeks.map(w => weeklyData[w].xp));
                
                const bars = weeks.map((week, i) => {
                    const xp = weeklyData[week].xp;
                    const height = (xp / maxXP) * 100;
                    const weekNum = i + 1;
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">${xp}</div>
                            <div style="width: 20px; background: linear-gradient(to top, #1e40af, #3b82f6); height: ${height}%; min-height: 4px; border-radius: 2px;"></div>
                            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px;">Н${weekNum}</div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div style="display: flex; align-items: end; gap: 8px; height: 100%; padding: 16px;">
                        ${bars}
                    </div>
                `;
            }

            function renderProgressCharts() {
                renderActivityHeatmap();
                renderMonthlyChart();
                renderTaskDistribution();
                renderLevelTimeline();
            }

            function renderActivityHeatmap() {
                const container = document.getElementById('activityHeatmap');
                if (!container) return;
                
                const today = new Date();
                const oneYearAgo = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
                
                const cells = [];
                const current = new Date(oneYearAgo);
                
                while (current <= today) {
                    const dateKey = formatDate(current);
                    const state = getEffectiveState();
                    const logs = (state.activityData[dateKey] || []);
                    const xp = logs.reduce((sum, log) => sum + (log.xpEarned || 0), 0);
                    
                    let level = 0;
                    if (xp > 0) level = 1;
                    if (xp >= 100) level = 2;
                    if (xp >= 200) level = 3;
                    if (xp >= 300) level = 4;
                    if (xp >= 400) level = 5;
                    
                    cells.push(`<div class="heatmap-cell" data-level="${level}" title="${dateKey}: ${xp} XP"></div>`);
                    current.setDate(current.getDate() + 1);
                }
                
                container.innerHTML = cells.join('');
            }

            function renderPatternCharts() {
                renderWeekdayPattern();
                renderSessionsChart();
                updatePerformanceStats();
                updatePredictions();
            }

            function renderWeekdayPattern() {
                const container = document.getElementById('weekdayPatternChart');
                if (!container) return;
                
                const analytics = computeAnalyticsData();
                const weekdayLabels = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                const maxXP = Math.max(1, ...analytics.weekdayData);
                
                const bars = analytics.weekdayData.map((xp, i) => {
                    const height = (xp / maxXP) * 100;
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">${xp}</div>
                            <div style="width: 24px; background: linear-gradient(to top, #0ea5e9, #38bdf8); height: ${height}%; min-height: 4px; border-radius: 2px;"></div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">${weekdayLabels[i]}</div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div style="display: flex; align-items: end; gap: 4px; height: 100%; padding: 16px;">
                        ${bars}
                    </div>
                `;
            }

            function renderAchievementCharts() {
                updateMilestones();
                updateRecords();
                renderComparisonChart();
            }

            function updatePerformanceStats() {
                const analytics = computeAnalyticsData();
                document.getElementById('bestWeekday').textContent = analytics.bestWeekday;
                document.getElementById('avgTasksPerDay').textContent = (analytics.totalTasksCompleted / Math.max(1, analytics.totalActiveDays)).toFixed(1);
                document.getElementById('xpGrowth').textContent = `+${analytics.recentXP} XP`;
            }

            function updatePredictions() {
                const analytics = computeAnalyticsData();
                document.getElementById('timeToMax').textContent = typeof analytics.weeksToMax === 'number' ? `${analytics.weeksToMax} недель` : analytics.weeksToMax;
                document.getElementById('nextStarTime').textContent = analytics.nextStarXP;
                const monthlyXP = analytics.avgXpPerDay * 30;
                const monthlyProgress = Math.min(100, (monthlyXP / 1000) * 100);
                document.getElementById('monthlyGoal').textContent = `${monthlyProgress.toFixed(0)}%`;
            }

            function updateMilestones() {
                const container = document.getElementById('milestonesContent');
                const state = getEffectiveState();
                const milestones = [
                    { level: 10, achieved: state.progress.level >= 10, title: 'Первые 10 уровней' },
                    { level: 25, achieved: state.progress.level >= 25, title: 'Четверть пути' },
                    { level: 50, achieved: state.progress.level >= 50, title: 'Половина пути' },
                    { level: 75, achieved: state.progress.level >= 75, title: 'Три четверти' },
                    { level: 100, achieved: state.progress.level >= 100, title: 'Максимальный уровень' }
                ];
                
                container.innerHTML = milestones.map(m => `
                    <div class="stat-row">
                        <span class="stat-label">${m.title}</span>
                        <span class="stat-value" style="color: ${m.achieved ? '#059669' : '#94a3b8'};">
                            ${m.achieved ? '✓ Получено' : `Уровень ${m.level}`}
                        </span>
                    </div>
                `).join('');
            }

            function updateRecords() {
                const analytics = computeAnalyticsData();
                document.getElementById('maxDayXp').textContent = analytics.bestDayXP + ' XP';
                document.getElementById('maxDayTasks').textContent = analytics.maxDayTasks;
                document.getElementById('bestWeekXp').textContent = analytics.bestWeekXP + ' XP';
            }

            // Stub functions for charts that would need more complex implementation
            function renderMonthlyChart() {
                const container = document.getElementById('monthlyXpChart');
                if (!container) return;
                const state = getEffectiveState();
                const activity = state.activityData || {};
                const byMonth = {};
                Object.keys(activity).forEach(d => {
                    const [y,m] = d.split('-');
                    const key = `${y}-${m}`;
                    const sum = activity[d].reduce((s,l)=>s+(l.xpEarned||0),0);
                    byMonth[key] = (byMonth[key]||0)+sum;
                });
                const keys = Object.keys(byMonth).sort().slice(-12);
                const maxXP = Math.max(100, ...keys.map(k => byMonth[k]));
                const bars = keys.map(k => {
                    const xp = byMonth[k];
                    const h = Math.max(4, Math.round((xp/maxXP)*100));
                    const label = k.split('-')[1]+'.'+k.split('-')[0].slice(2);
                    return `<div style="display:flex;flex-direction:column;align-items:center;flex:1;">
                        <div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;">${xp}</div>
                        <div style="width:20px;background:linear-gradient(to top,#8b5cf6,#a78bfa);height:${h}%;border-radius:2px;"></div>
                        <div style="font-size:0.7rem;color:#94a3b8;margin-top:4px;">${label}</div>
                    </div>`;
                }).join('');
                container.innerHTML = `<div style="display:flex;align-items:end;gap:8px;height:100%;padding:16px;">${bars}</div>`;
            }
            function renderTaskDistribution() {
                const container = document.getElementById('taskDistributionChart');
                if (!container) return;
                const state = getEffectiveState();
                const activity = state.activityData || {};
                const counts = {};
                Object.keys(activity).forEach(d => {
                    (activity[d]||[]).forEach(l => {
                        const cat = l.category || inferCategoryFromTaskName(l.taskName) || 'other';
                        counts[cat] = (counts[cat]||0) + 1;
                    });
                });
                const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
                const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const colors = ['#ec4899','#f59e0b','#10b981','#3b82f6','#8b5cf6'];
                const rows = entries.map(([cat, n], idx) => {
                    const pct = Math.round((n/total)*100);
                    return `<div style="width:100%;margin:6px 0;">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:#64748b;">
                            <span>${mapCategoryTitle(cat)}</span><span>${pct}%</span>
                        </div>
                        <div style="height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
                            <div style="width:${pct}%;height:100%;background:${colors[idx%colors.length]};"></div>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML = `<div style="padding:8px 4px;">${rows || '<div style=\"color:#94a3b8;text-align:center\">Нет данных</div>'}</div>`;
            }
            function inferCategoryFromTaskName(name) {
                const n = (name||'').toLowerCase();
                if (n.includes('слов')) return 'vocabulary';
                if (n.includes('граммат')) return 'grammar';
                if (n.includes('аудир')) return 'listening';
                if (n.includes('чтен')) return 'reading';
                if (n.includes('разговор')) return 'speaking';
                return null;
            }
            function mapCategoryTitle(cat) {
                const map = { vocabulary: 'Слова', grammar: 'Грамматика', listening: 'Аудирование', reading: 'Чтение', speaking: 'Разговор', other: 'Другое' };
                return map[cat] || cat;
            }
            function renderLevelTimeline() {
                const container = document.getElementById('levelTimelineChart');
                if (!container) return;
                const state = getEffectiveState();
                // approximate weekly levels over last 12 weeks
                const analytics = computeAnalyticsData();
                const weeks = Object.keys(analytics.weeklyData).sort().slice(-12);
                let cumulative = Math.max(1, state.progress.level - weeks.length);
                const items = weeks.map((w,i)=>{
                    const inc = Math.max(0, Math.floor(analytics.weeklyData[w].xp / 810));
                    cumulative = Math.min(100, cumulative + inc);
                    return `<div style="display:flex;flex-direction:column;align-items:center;flex:1;">
                        <div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;">Lv.${cumulative}</div>
                        <div style="width:24px;height:24px;background:linear-gradient(135deg,#1e40af,#3b82f6);border-radius:6px;"></div>
                        <div style="font-size:0.7rem;color:#94a3b8;margin-top:4px;">Н${i+1}</div>
                    </div>`;
                }).join('');
                container.innerHTML = `<div style="display:flex;align-items:end;gap:8px;height:100%;padding:16px;">${items}</div>`;
            }
            function renderSessionsChart() {
                const container = document.getElementById('sessionsChart');
                if (!container) return;
                const state = getEffectiveState();
                const today = new Date();
                const days = [];
                for (let i=29;i>=0;i--) {
                    const d = new Date(today); d.setDate(d.getDate()-i);
                    const key = formatDate(d);
                    const sessions = (state.activityData[key]||[]).length;
                    days.push({ key, sessions });
                }
                const max = Math.max(1, ...days.map(d=>d.sessions));
                const bars = days.map(d=>{
                    const h = Math.round((d.sessions/max)*100);
                    return `<div title="${d.key}: ${d.sessions}" style="width:10px;background:linear-gradient(to top,#059669,#10b981);height:${Math.max(4,h)}%;border-radius:2px;"></div>`;
                }).join('');
                container.innerHTML = `<div style="display:flex;align-items:end;gap:2px;height:100%;padding:8px 12px;">${bars}</div>`;
            }
            function renderComparisonChart() {
                const container = document.getElementById('comparisonChart');
                if (!container) return;
                const analytics = computeAnalyticsData();
                const weeks = Object.keys(analytics.weeklyData).sort();
                const last8 = weeks.slice(-8);
                const prev4 = last8.slice(0,4);
                const last4 = last8.slice(4);
                const maxXP = Math.max(100, ...last8.map(w=>analytics.weeklyData[w].xp));
                const makeBars = (arr, color) => arr.map(w=>{
                    const xp = analytics.weeklyData[w].xp;
                    const h = Math.round((xp/maxXP)*100);
                    return `<div style="width:18px;background:${color};height:${Math.max(4,h)}%;border-radius:2px;" title="${w}: ${xp}"></div>`;
                }).join('');
                container.innerHTML = `
                    <div style="display:flex;align-items:end;gap:16px;height:100%;padding:12px 16px;">
                        <div style="display:flex;align-items:end;gap:6px;">${makeBars(prev4,'#94a3b8')}</div>
                        <div style="display:flex;align-items:end;gap:6px;">${makeBars(last4,'#1e40af')}</div>
                    </div>
                `;
            }

            // Demo toggle UI
            function toggleDemoAnalytics() {
                appState.demoAnalytics = appState.demoAnalytics || { enabled: false };
                appState.demoAnalytics.enabled = !appState.demoAnalytics.enabled;
                if (appState.demoAnalytics.enabled) {
                    demoStateCache = buildDemoState();
                } else {
                    demoStateCache = null;
                }
                // Update UI controls
                const badge = document.getElementById('demoBadge');
                const btn = document.getElementById('toggleDemoBtn');
                if (badge) badge.style.display = appState.demoAnalytics.enabled ? 'inline-flex' : 'none';
                if (btn) btn.textContent = appState.demoAnalytics.enabled ? 'Выключить демо' : 'Демо';
                // Re-render current analytics tab
                calculateAnalytics();
                renderProgressCharts();
                renderPatternCharts();
                renderAchievementCharts();
            }

            // Initialize app when page loads
            document.addEventListener("DOMContentLoaded", initApp);

            // Autocomplete interactions for reward ideas
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id === 'ideaDescription') {
                    renderIdeaSuggestions(e.target.value);
                }
            });
            document.addEventListener('click', function(e) {
                const list = document.getElementById('ideaAutocomplete');
                const input = document.getElementById('ideaDescription');
                if (!list || !input) return;
                // Remove item
                const removeBtn = e.target.closest && e.target.closest('.autocomplete-remove');
                if (removeBtn) {
                    const val = removeBtn.getAttribute('data-remove');
                    removeIdea(val);
                    renderIdeaSuggestions(input.value || '');
                    e.stopPropagation();
                    return;
                }
                // Pick item
                const item = e.target.closest && e.target.closest('.autocomplete-item');
                if (item && item.getAttribute('data-value')) {
                    input.value = item.getAttribute('data-value');
                    list.style.display = 'none';
                    list.innerHTML = '';
                    input.focus();
                    return;
                }
                // Click outside autocomplete closes it
                if (!e.target.closest('.autocomplete-wrap')) {
                    list.style.display = 'none';
                    list.innerHTML = '';
                }
            });

            // Account selection & role handling
            function selectAccount(role) {
                appState.role = role === 'admin' ? 'admin' : 'viewer';
                saveState();
                document.getElementById('accountModal').classList.remove('show');
                applyRolePermissions();
                if (appState.role === 'viewer') showWelcomeModal();
                showNotification(appState.role === 'admin' ? 'Режим администратора' : 'Режим просмотра', 'info');
            }

            // Change Account Modal
            function showChangeAccountModal() {
                document.getElementById('accountModal').classList.add('show');
                toggleSettingsMenu(); // Close settings menu
            }

            // Proper offline QR encoder (fallback, не переопределяет основную версию)
            function drawQrToCanvasFallback(text) {
                const canvas = document.getElementById('qrCanvas');
                if (!canvas) return;
                
                // Simple but effective QR-like pattern generator
                const ctx = canvas.getContext('2d');
                const size = canvas.width;
                
                // Clear canvas
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, size, size);
                
                // Generate deterministic pattern based on text
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) - hash + text.charCodeAt(i)) >>> 0;
                }
                
                // Create QR-like grid pattern
                const gridSize = 8;
                const cells = size / gridSize;
                
                ctx.fillStyle = '#000000';
                for (let y = 0; y < cells; y++) {
                    for (let x = 0; x < cells; x++) {
                        // Use hash to determine if cell should be filled
                        hash = (hash * 1103515245 + 12345) >>> 0;
                        if ((hash & 1) === 0) {
                            ctx.fillRect(x * gridSize + 1, y * gridSize + 1, gridSize - 2, gridSize - 2);
                        }
                    }
                }
                
                // Add corner markers (QR code style)
                ctx.fillStyle = '#000000';
                // Top-left corner
                ctx.fillRect(0, 0, gridSize * 3, gridSize * 3);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(gridSize, gridSize, gridSize, gridSize);
                // Top-right corner
                ctx.fillStyle = '#000000';
                ctx.fillRect(size - gridSize * 3, 0, gridSize * 3, gridSize * 3);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(size - gridSize * 2, gridSize, gridSize, gridSize);
                // Bottom-left corner
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, size - gridSize * 3, gridSize * 3, gridSize * 3);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(gridSize, size - gridSize * 2, gridSize, gridSize);
            }
        </script>
    </body>
</html>
