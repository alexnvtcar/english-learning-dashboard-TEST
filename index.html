<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Геймификация изучения английского языка</title>
        <!-- Offline mode: removed external icon/font links -->
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <!-- Settings Panel -->
        <div class="settings-panel">
            <button class="settings-btn" onclick="toggleSettingsMenu()" aria-label="Открыть настройки" aria-haspopup="true" aria-expanded="false">
                ⚙️
            </button>

            <button class="save-btn" onclick="saveDataToFirebase()" aria-label="Сохранить данные" title="Сохранить в Firebase">
                <span class="save-icon">💾</span>
                <span class="save-text">Сохранить</span>
            </button>
            <div class="settings-menu" id="settingsMenu">
                <!-- Кнопка закрытия -->
                <div class="settings-close-btn" onclick="closeSettingsMenu()" aria-label="Закрыть настройки">
                    ✕
                </div>
                <!-- Основные настройки -->
                <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Основные настройки</div>
                <div class="settings-block-content">
                    <div class="settings-item" onclick="showChangeAccountModal()">
                        👤
                        Сменить учетную запись
                    </div>
                </div>
                <!-- Блок управления PIN-кодами -->
                <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Управление PIN-кодами</div>
                <div class="settings-block-content">
                    <div class="settings-item" onclick="showChangePinModal()">
                        🔐
                        Сменить PIN-код
                    </div>
                    <div class="settings-item" onclick="forceSyncPinCodes().then(success => { if(success) showNotification('PIN-коды синхронизированы', 'success'); else showNotification('Ошибка синхронизации PIN-кодов', 'error'); }).catch(error => { showNotification('Ошибка синхронизации', 'error'); })">
                        🔄
                        Синхронизировать PIN-коды
                    </div>
                    <div class="settings-item" onclick="forceRestorePinCodes().then(success => { if(success) showNotification('PIN-коды восстановлены из Firebase', 'success'); else showNotification('PIN-коды не найдены в Firebase', 'warning'); }).catch(error => { showNotification('Ошибка восстановления', 'error'); })">
                        🔐
                        Восстановить PIN-коды из Firebase
                    </div>
                </div>
                
                <hr class="settings-divider" id="dividerBeforeTech">
                <!-- Блок технической диагностики -->
                <div class="settings-block" id="techDiagnosticsBlock">
                    <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Техническая диагностика</div>
                    <div class="settings-block-content">
                        <div class="settings-item" onclick="forceShowVerification(); showNotification('Верификация принудительно показана', 'info');">
                            🔐
                            Показать верификацию
                        </div>
                        <div class="settings-item" onclick="testFirebaseConnection()">
                            🧪
                            Тест Firebase
                        </div>
                        <div class="settings-item" onclick="showFirebaseDiagnostics()">
                            🔍
                            Диагностика Firebase
                        </div>
                        <div class="settings-item" onclick="checkDeviceCapabilities()">
                            📱
                            Диагностика устройства
                        </div>
                    </div>
                </div>
                                <hr class="settings-divider" id="dividerBeforeFirebase">
                <!-- Блок Firebase операций -->
                <div class="settings-block" id="firebaseOperationsBlock">
                    <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Firebase операции</div>
                    <div class="settings-block-content">
                        <div class="settings-item" onclick="saveDataToFirebase()">
                            💾
                            Сохранить в Firebase
                        </div>
                        <div class="settings-item" onclick="syncWithFirestore()">
                            🔄
                            Синхронизировать
                        </div>
                    </div>
                </div>
                
                <hr class="settings-divider">
                
                <!-- Блок управления данными -->
                <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Управление данными</div>
                <div class="settings-block-content">
                    <div class="settings-item" onclick="exportData()">
                        💾
                        Экспорт данных
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFile').click()">
                        📤
                        Импорт данных
                    </div>
                </div>
                 
                 <hr class="settings-divider" id="dividerBeforeDanger">
                 
                                 <!-- Блок опасных операций -->
                <div class="settings-block" id="dangerousOperationsBlock">
                    <div class="settings-block-title" onclick="toggleSettingsBlock(this)">Опасные операции</div>
                    <div class="settings-block-content">
                        <div class="settings-item danger" onclick="clearTasks()">
                            🗑️
                            Очистить задания
                        </div>
                        <div class="settings-item danger" onclick="clearRewards()">
                            🎁
                            Очистить награды
                        </div>
                        <div class="settings-item danger" onclick="resetProgress()">
                            🔄
                            Сбросить прогресс
                        </div>
                    </div>
                </div>
            </div>
            <input type="file" id="importFile" class="file-input" accept="application/json,.json" onchange="importData(event)">
        </div>

        



        <!-- Modal Overlay for background dimming -->
        <div class="modal-overlay" id="modalOverlay"></div>

        <div class="container">
            <!-- Main Header -->
            <div class="card main-header">
                <h1>Авторская программа изучения английского языка</h1>
                <p>Изучение английского языка</p>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-3">
                <div class="card stat-card">
                                    <div class="stat-icon">
                    🏆
                </div>
                    <div class="stat-label">Текущий уровень</div>
                    <div class="stat-value" id="currentLevel">15</div>
                    <div style="font-size: 0.875rem; color: #64748b">
                        Продвинутый
                    </div>
                </div>

                <div class="card stat-card">
                                    <div class="stat-icon">
                    ⭐
                </div>
                    <div class="stat-label">Общий опыт</div>
                    <div class="stat-value" id="totalXP">4250</div>
                    <div style="font-size: 0.875rem; color: #64748b">XP</div>
                </div>

                <div class="card stat-card">
                    <div class="stat-icon">
                        🏆
                    </div>
                    <div class="stat-label">Лучшая неделя</div>
                    <div class="stat-value" id="bestWeekXP">0 XP</div>
                    <div id="bestWeekSubtitle" style="font-size: 0.875rem; color: #64748b">
                        максимальный XP за неделю
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2">
                <!-- Progress Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            📊
                            Прогресс обучения
                        </h2>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button class="calendar-nav" id="weekPrevBtn" onclick="changeWeek(-1)" title="Предыдущая неделя">
                                    ◀️
                                </button>
                                <div class="month-title" id="weekRangeLabel" style="text-align:left; min-width: 220px;">
                                    Текущая неделя
                                </div>
                                <button class="calendar-nav" id="weekNextBtn" onclick="changeWeek(1)" title="Следующая неделя">
                                    ▶️
                                </button>
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 12px;
                            "
                        >
                            <span style="font-weight: 600; color: #1e293b"
                                >До следующего уровня</span
                            >
                            <span
                                style="font-weight: 600; color: #1e40af"
                                id="xpProgress"
                                >—</span
                            >
                        </div>
                        <div class="progress-container">
                            <div
                                class="progress-bar"
                                id="levelProgress"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>

                    <div style="margin-top: 32px">
                        <h3
                            style="
                                font-size: 1rem;
                                font-weight: 600;
                                color: #1e293b;
                                margin-bottom: 16px;
                            "
                        >
                            Еженедельные цели
                        </h3>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 12px;
                            "
                        >
                            <span>Недельный прогресс</span>
                            <span
                                style="font-weight: 600; color: #1e40af"
                                id="weeklyProgress"
                                >—</span
                            >
                        </div>
                        <div class="progress-container" id="weeklyProgressContainer">
                            <div class="progress-marker" id="marker500" style="left: calc(500/750 * 100%);">
                                <div class="progress-label">500 XP</div>
                            </div>
                            <div class="progress-marker right" id="marker750" style="left: 100%;">
                                <div class="progress-label">750 XP</div>
                            </div>
                            <div class="progress-bar" id="weeklyBar" style="width: 0%"></div>
                        </div>

                        

                        <div id="weeklyChart" class="weekly-chart" aria-label="XP за дни недели"></div>

                        <div style="margin-top: 24px;">
                            <h3
                                style="
                                    font-size: 1rem;
                                    font-weight: 600;
                                    color: #1e293b;
                                    margin-bottom: 12px;
                                "
                            >
                                Прогресс за месяц
                            </h3>
                            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
                                <span>Месячный прогресс</span>
                                <span id="monthlyProgressText" style="font-weight:600; color:#1e40af;">—</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" id="monthlyBar" style="width: 0%"></div>
                            </div>
                            <div id="monthlyInlineChart" class="weekly-chart" aria-label="XP по дням месяца" style="grid-template-columns: repeat( auto-fit, minmax(16px, 1fr) );"></div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="card">
                    <div
                        class="card-header"
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        "
                    >
                        <h2 class="card-title">
                            📋
                            Задания
                        </h2>
                        <button
                            class="btn btn-primary"
                            onclick="showTaskModal()"
                        >
                            ➕
                            Добавить
                        </button>
                    </div>

                    <div class="task-list" id="taskList">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2">
                <!-- Achievements and Rewards -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            🏅
                            Достижения и награды
                        </h2>
                    </div>

                    <div>
                        <h3
                            style="
                                font-size: 0.875rem;
                                font-weight: 600;
                                color: #64748b;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                                margin-bottom: 12px;
                            "
                        >
                            Полученные достижения
                        </h3>
                        <div class="achievements">
                            <div class="achievement-badge">
                                🔥
                                Огненная серия
                            </div>
                            <div class="achievement-badge">
                                ⭐
                                Первые шаги
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 32px">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">
                                Последние награды
                            </h3>
                            <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                                <div class="redeem-stars-container" aria-label="Банк звезд" title="Ваши накопленные звезды для награды">
                                    <span class="redeem-star" id="bankStar1">⭐</span>
                                    <span class="redeem-star" id="bankStar2">⭐</span>
                                    <span class="redeem-star" id="bankStar3">⭐</span>
                                </div>
                                <div style="min-width: 70px; text-align: right; font-weight:600; color:#1e40af;" id="bankStarsText">0 ⭐</div>
                                <button class="btn btn-secondary" id="ideaBtn" onclick="showIdeaModal()" title="Придумать и сохранить награду">
                                    💡
                                    Придумать награду
                                </button>
                                <button class="btn btn-primary" onclick="showRewardModal()" id="redeemBtn">
                                    🎁
                                    Получить
                                </button>
                            </div>
                        </div>
                        <div id="plannedRewardCard" style="display:none; background:#fffbeb; border:1px solid #fde68a; color:#92400e; padding:12px; border-radius:10px; margin-bottom:12px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <div style="display:flex; align-items:center; gap:8px; font-weight:600;">
                                    ✏️
                                    Запланированная награда:
                                </div>
                                <div style="font-size:0.9rem; color:#78350f;" id="plannedRewardText">—</div>
                            </div>
                        </div>
                        <div id="rewardsList">
                            <div
                                style="
                                    text-align: center;
                                    padding: 20px;
                                    color: #64748b;
                                    font-size: 0.875rem;
                                "
                            >
                                Пока нет полученных наград
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Learning Time -->
                <div class="card learning-time-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            ⏱️
                            Время обучения
                        </h2>
                    </div>

                    <div class="learning-time-content">
                        <!-- Основная статистика времени -->
                        <div class="time-stats-grid">
                            <div class="time-stat-card total-time">
                                <div class="time-stat-icon">🕐</div>
                                <div class="time-stat-content">
                                    <div class="time-stat-value" id="totalLearningTime">00:00</div>
                                    <div class="time-stat-label">Всего времени</div>
                                </div>
                                <div class="time-stat-sparkle">✨</div>
                            </div>
                            
                            <div class="time-stat-card weekly-avg">
                                <div class="time-stat-icon">📅</div>
                                <div class="time-stat-content">
                                    <div class="time-stat-value" id="weeklyAvgTime">00:00</div>
                                    <div class="time-stat-label">В среднем в неделю</div>
                                </div>
                                <div class="time-stat-pulse"></div>
                            </div>
                            
                            <div class="time-stat-card daily-avg">
                                <div class="time-stat-icon">📊</div>
                                <div class="time-stat-content">
                                    <div class="time-stat-value" id="dailyAvgTime">00:00</div>
                                    <div class="time-stat-label">В среднем в день</div>
                                </div>
                                <div class="time-stat-pulse"></div>
                            </div>
                        </div>

                        <!-- Круговая диаграмма времени по дням недели -->
                        <div class="time-chart-section">
                            <h3 class="time-section-title">Время по дням недели</h3>
                            <div class="time-chart-container">
                                <div class="time-chart" id="weeklyTimeChart">
                                    <div class="time-chart-center">
                                        <div class="time-chart-total">0ч</div>
                                        <div class="time-chart-label">в неделю</div>
                                    </div>
                                </div>
                                <div class="time-chart-legend" id="weeklyTimeLegend">
                                    <!-- Легенда будет генерироваться динамически -->
                                </div>
                            </div>
                        </div>




                    </div>
                </div>

                <!-- Calendar -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            📅
                            Календарь активности
                        </h2>
                    </div>

                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">
                            ◀️
                        </button>
                        <div class="month-title" id="monthTitle">
                            Январь 2025
                        </div>
                        <button class="calendar-nav" onclick="changeMonth(1)">
                            ▶️
                        </button>
                    </div>

                    <!-- Легенда календаря -->
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color activity-low"></div>
                            <span>Меньше 30 мин</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color activity-medium"></div>
                            <span>30-59 мин</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color activity-high"></div>
                            <span>1-2 часа</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color activity-very-high"></div>
                            <span>Больше 2 часов</span>
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(7, 1fr);
                            gap: 8px;
                            margin-bottom: 8px;
                            font-size: 0.75rem;
                            font-weight: 600;
                            color: #64748b;
                            text-align: center;
                        "
                    >
                        <div>ПН</div>
                        <div>ВТ</div>
                        <div>СР</div>
                        <div>ЧТ</div>
                        <div>ПТ</div>
                        <div>СБ</div>
                        <div>ВС</div>
                    </div>

                    <div class="calendar" id="calendar">
                        <!-- Calendar days will be generated here -->
                    </div>

                    <div
                        style="
                            margin-top: 20px;
                            padding-top: 16px;
                            border-top: 1px solid #e2e8f0;
                        "
                    >
                        <h4
                            style="
                                font-weight: 600;
                                color: #1e293b;
                                margin-bottom: 12px;
                            "
                            id="selectedDateTitle"
                        >
                            Активность за сегодня
                        </h4>
                        <div
                            id="dayActivity"
                            style="font-size: 0.875rem; color: #64748b"
                        >
                            Пока нет активности за выбранный день
                        </div>
                    </div>
                </div>
                

            </div>
        </div>



        <!-- Task Modal -->
        <div class="modal" id="taskModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
                <button class="close-btn" onclick="hideTaskModal()">
                    &times;
                </button>
                <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">Добавить новое задание</h3>
                </div>

                <form id="taskForm" onsubmit="addTask(event)" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label">Название задания</label>
                        <input
                            type="text"
                            class="form-input"
                            id="taskName"
                            name="taskName"
                            placeholder="Например: Изучение новых слов"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            inputmode="text"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Описание</label>
                        <textarea
                            class="form-input"
                            id="taskDescription"
                            name="taskDescription"
                            rows="3"
                            placeholder="Краткое описание задания"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Иконка задания</label>
                        <div class="icon-selector" id="iconSelector">
                            <!-- Icons will be populated by JavaScript -->
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label">Награда (XP)</label>
                            <input
                                type="number"
                                class="form-input"
                                id="taskXP"
                                name="taskXP"
                                value="50"
                                min="10"
                                max="500"
                                autocomplete="off"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Длительность (мин)</label>
                            <input
                                type="number"
                                class="form-input"
                                id="taskDuration"
                                name="taskDuration"
                                value="15"
                                min="5"
                                max="120"
                                autocomplete="off"
                            />
                        </div>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                            margin-top: 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="hideTaskModal()"
                        >
                            Отмена
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Добавить задание                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reward Modal -->
        <div class="modal" id="rewardModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="rewardModalTitle">
                <button class="close-btn" onclick="hideRewardModal()">
                    &times;
                </button>
                <div class="modal-header">
                    <h3 class="modal-title" id="rewardModalTitle">Получить награду</h3>
                </div>

                <form id="rewardForm" onsubmit="addReward(event)">
                    <div class="form-group">
                        <label class="form-label">Запланированная награда</label>
                 <div id="plannedRewardDisplay" style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; color: #1e293b;">
                            —
                        </div>
                    </div>

                    <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Доступно звезд:</span>
                            <span style="font-weight: 600; color: #1e40af" id="availableStars">0 ⭐</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span>Требуется для награды:</span>
                            <span style="font-weight: 600; color: #1e293b">3 ⭐</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="hideRewardModal()">❌ Отмена</button>
                        <button type="submit" class="btn btn-primary" id="confirmRedeemBtn">
                            🎁
                            Получить награду
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Idea Modal -->
        <div class="modal" id="ideaModal">
            <div class="modal-content" style="position: relative" role="dialog" aria-modal="true" aria-labelledby="ideaModalTitle">
                <button class="close-btn" onclick="hideIdeaModal()">&times;</button>
                <div class="modal-header">
                    <h3 class="modal-title" id="ideaModalTitle">Придумать награду</h3>
                </div>
                <form id="ideaForm" onsubmit="saveRewardIdea(event)">
                    <div class="form-group">
                        <label class="form-label">Название награды</label>
                        <div class="autocomplete-wrap">
                            <input type="text" class="form-input" id="ideaDescription" placeholder="Например: Поход в кино" required autocomplete="off" />
                            <div class="autocomplete-list" id="ideaAutocomplete"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="hideIdeaModal()">❌ Отмена</button>
                                                    <button type="submit" class="btn btn-primary">
                                ✅
                                Сохранить
                            </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification" role="status" aria-live="polite" aria-atomic="true">
            ✅
            <span id="notificationMessage"></span>
        </div>

        <!-- Account Modal -->
        <div class="modal" id="accountModal">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle" style="max-width:520px; position:relative;">
                <div class="modal-header">
                    <h3 class="modal-title" id="accountModalTitle">Выберите учетную запись</h3>
                </div>
                <div style="display:flex; gap:12px; flex-direction:column;">
                                        <button class="btn btn-primary" onclick="selectAccount('viewer')" style="justify-content:center;">
                        👤 Михаил (только просмотр)
                    </button>
                                        <button class="btn btn-secondary" onclick="selectAccount('admin')" style="justify-content:center; background: #fbbf24; color: #92400e; border-color: #f59e0b;">
                         👑 Admin (полные права)
                     </button>
                </div>
            </div>
        </div>

        <!-- Verification Modal -->
        <div class="modal" id="verificationModal">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="verificationModalTitle" style="max-width:400px; position:relative;">
                <div class="modal-header">
                    <h3 class="modal-title" id="verificationModalTitle">🔐 Верификация</h3>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Введите PIN-код для входа в профиль</div>
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937;" id="verificationUserInfo">Михаил</div>
                    </div>
                    
                    <!-- PIN Input Display -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">
                            <div class="pin-dot" id="pinDot1"></div>
                            <div class="pin-dot" id="pinDot2"></div>
                            <div class="pin-dot" id="pinDot3"></div>
                            <div class="pin-dot" id="pinDot4"></div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;" id="pinStatus">Введите 4-значный код</div>
                    </div>
                    
                    <!-- Numeric Keypad -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 240px; margin: 0 auto;">
                        <button class="pin-btn" onclick="addPinDigit('1')">1</button>
                        <button class="pin-btn" onclick="addPinDigit('2')">2</button>
                        <button class="pin-btn" onclick="addPinDigit('3')">3</button>
                        <button class="pin-btn" onclick="addPinDigit('4')">4</button>
                        <button class="pin-btn" onclick="addPinDigit('5')">5</button>
                        <button class="pin-btn" onclick="addPinDigit('6')">6</button>
                        <button class="pin-btn" onclick="addPinDigit('7')">7</button>
                        <button class="pin-btn" onclick="addPinDigit('8')">8</button>
                        <button class="pin-btn" onclick="addPinDigit('9')">9</button>
                        <button class="pin-btn" onclick="addPinDigit('0')" style="grid-column: 2;">0</button>
                        <button class="pin-btn pin-btn-delete" onclick="deletePinDigit()">⌫</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="hideVerificationModal()">❌ Отмена</button>
                        <button class="btn btn-primary" onclick="verifyPin()" id="verifyBtn" disabled>✅ Войти</button>
                    </div>
                    
                    <!-- Setup PIN Button (shown only for new users) -->
                    <div style="margin-top: 16px; display: none;" id="setupPinSection">
                        <button class="btn btn-secondary" onclick="setupNewPin()" style="font-size: 14px;">
                            🔑 Установить PIN-код
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup PIN Modal -->
        <div class="modal" id="setupPinModal">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="setupPinModalTitle" style="max-width:400px; position:relative;">
                <div class="modal-header">
                    <h3 class="modal-title" id="setupPinModalTitle">🔑 Установка PIN-кода</h3>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Придумайте 4-значный PIN-код для профиля</div>
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937;" id="setupPinUserInfo">Михаил</div>
                    </div>
                    
                    <!-- PIN Input Display -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">
                            <div class="pin-dot" id="setupPinDot1"></div>
                            <div class="pin-dot" id="setupPinDot2"></div>
                            <div class="pin-dot" id="setupPinDot3"></div>
                            <div class="pin-dot" id="setupPinDot4"></div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;" id="setupPinStatus">Введите новый PIN-код</div>
                    </div>
                    
                    <!-- Numeric Keypad -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 240px; margin: 0 auto;">
                        <button class="pin-btn" onclick="addSetupPinDigit('1')">1</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('2')">2</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('3')">3</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('4')">4</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('5')">5</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('6')">6</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('7')">7</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('8')">8</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('9')">9</button>
                        <button class="pin-btn" onclick="addSetupPinDigit('0')" style="grid-column: 2;">0</button>
                        <button class="pin-btn pin-btn-delete" onclick="deleteSetupPinDigit()">⌫</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="hideSetupPinModal()">❌ Отмена</button>
                        <button class="btn btn-primary" onclick="confirmSetupPin()" id="confirmSetupBtn" disabled>✅ Сохранить</button>
                    </div>
                </div>
            </div>
        </div>



                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <div class="analytics-grid">
                        <!-- Total Stats Card -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        🏆
                                    </div>
                                    Общая статистика
                                </div>
                            </div>
                            <div id="totalStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Всего дней с активностью</span>
                                    <span class="stat-value" id="totalActiveDays">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Всего заданий выполнено</span>
                                    <span class="stat-value" id="totalTasksCompleted">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Среднее XP в день</span>
                                    <span class="stat-value" id="avgXpPerDay">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Лучший день (XP)</span>
                                    <span class="stat-value" id="bestDay">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Level Progress Ring -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                        📈
                                    </div>
                                    Прогресс уровня
                                </div>
                            </div>
                            <div class="progress-ring" id="levelProgressRing">
                                <svg viewBox="0 0 120 120">
                                    <circle class="progress-ring-bg" cx="60" cy="60" r="52"></circle>
                                    <circle class="progress-ring-fill" cx="60" cy="60" r="52" 
                                            stroke-dasharray="0 327" id="levelRingFill"></circle>
                                </svg>
                                <div class="progress-ring-text" id="levelRingText">Lv.1</div>
                            </div>
                        </div>

                        <!-- Weekly XP Trend -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        📊
                                    </div>
                                    Тренд XP по неделям
                                </div>
                            </div>
                            <div class="chart-container chart-large" id="weeklyTrendChart"></div>
                        </div>

                        <!-- Best Week -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        🏆
                                    </div>
                                    Лучшая неделя
                                </div>
                            </div>
                            <div id="bestWeekStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Максимальный XP</span>
                                    <span class="stat-value" id="bestWeekXPStat">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Неделя</span>
                                    <span class="stat-value" id="bestWeekDate">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Задания выполнено</span>
                                    <span class="stat-value" id="bestWeekTasks">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stars Analytics -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        ⭐
                                    </div>
                                    Звезды и награды
                                </div>
                            </div>
                            <div id="starsStatsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Всего звезд заработано</span>
                                    <span class="stat-value" id="totalStarsEarned">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Звезд потрачено</span>
                                    <span class="stat-value" id="starsSpent">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Наград получено</span>
                                    <span class="stat-value" id="rewardsCount">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Tab -->
                <div class="tab-content" id="progress-tab">
                    <div class="analytics-grid">
                        <!-- Activity Heatmap -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        📅
                                    </div>
                                    Карта активности (последний год)
                                </div>
                            </div>
                            <div id="activityHeatmap" class="heatmap"></div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; font-size: 0.85rem; color: #64748b;">
                                <span>Меньше</span>
                                <div style="display: flex; gap: 3px;">
                                    <div class="heatmap-cell"></div>
                                    <div class="heatmap-cell" data-level="1"></div>
                                    <div class="heatmap-cell" data-level="2"></div>
                                    <div class="heatmap-cell" data-level="3"></div>
                                    <div class="heatmap-cell" data-level="4"></div>
                                    <div class="heatmap-cell" data-level="5"></div>
                                </div>
                                <span>Больше</span>
                            </div>
                        </div>

                        <!-- Monthly Progress -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                                        📊
                                    </div>
                                    XP по месяцам
                                </div>
                            </div>
                            <div class="chart-container" id="monthlyXpChart"></div>
                        </div>

                        <!-- Task Distribution -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                                        🥧
                                    </div>
                                    Типы заданий
                                </div>
                            </div>
                            <div class="chart-container chart-small" id="taskDistributionChart"></div>
                        </div>

                        <!-- Level Timeline -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        📈
                                    </div>
                                    Хронология уровней
                                </div>
                            </div>
                            <div class="chart-container" id="levelTimelineChart"></div>
                        </div>
                    </div>
                </div>

                <!-- Patterns Tab -->
                <div class="tab-content" id="patterns-tab">
                    <div class="analytics-grid">
                        <!-- Daily Pattern -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8);">
                                        ⏰
                                    </div>
                                    Дни недели
                                </div>
                            </div>
                            <div class="chart-container" id="weekdayPatternChart"></div>
                        </div>

                        <!-- Performance Trends -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        📈
                                    </div>
                                    Эффективность
                                </div>
                            </div>
                            <div id="performanceContent">
                                <div class="stat-row">
                                    <span class="stat-label">Самый продуктивный день недели</span>
                                    <span class="stat-value" id="bestWeekday">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Среднее заданий в день</span>
                                    <span class="stat-value" id="avgTasksPerDay">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Рост XP (последние 4 недели)</span>
                                    <span class="stat-value" id="xpGrowth">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Study Sessions -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
                                        📚
                                    </div>
                                    История сессий обучения
                                </div>
                            </div>
                            <div class="chart-container" id="sessionsChart"></div>
                        </div>

                        <!-- Prediction -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                        🔮
                                    </div>
                                    Прогнозы
                                </div>
                            </div>
                            <div id="predictionContent">
                                <div class="stat-row">
                                    <span class="stat-label">До 100 уровня</span>
                                    <span class="stat-value" id="timeToMax">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Следующая звезда через</span>
                                    <span class="stat-value" id="nextStarTime">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Месячная цель (1000 XP)</span>
                                    <span class="stat-value" id="monthlyGoal">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements Tab -->
                <div class="tab-content" id="achievements-tab">
                    <div class="analytics-grid">
                        <!-- Milestones -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                        🏅
                                    </div>
                                    Ключевые достижения
                                </div>
                            </div>
                            <div id="milestonesContent"></div>
                        </div>

                        <!-- Records -->
                        <div class="analytics-card">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                                        👑
                                    </div>
                                    Рекорды
                                </div>
                            </div>
                            <div id="recordsContent">
                                <div class="stat-row">
                                    <span class="stat-label">Максимум XP за день</span>
                                    <span class="stat-value" id="maxDayXp">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Максимум заданий за день</span>
                                    <span class="stat-value" id="maxDayTasks">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Лучшая неделя (XP)</span>
                                    <span class="stat-value" id="bestWeekXp">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Comparison -->
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-card-header">
                                <div class="analytics-card-title">
                                    <div class="analytics-card-icon" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                                        📊
                                    </div>
                                    Сравнение периодов
                                </div>
                            </div>
                            <div class="chart-container" id="comparisonChart"><canvas id="comparisonChartCanvas" class="chart-large" aria-label="Сравнение периодов"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Modal -->
        <div class="modal" id="welcomeModal">
            <div class="modal-content" style="position: relative; max-width: 640px;" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
                <button class="close-btn" onclick="hideWelcomeModal()">&times;</button>
                <div class="welcome-hero">
                    ✨
                    <div class="welcome-title" id="welcomeModalTitle">Welcome!</div>
                </div>
                <div class="welcome-text" id="welcomeMessage">
                    Great to see you! You're on a powerful journey to master English—let's make today count.
                </div>
                <div class="welcome-actions">
                    <button class="btn btn-secondary" onclick="hideWelcomeModal()">Close</button>
                    <button class="btn btn-primary" onclick="hideWelcomeModal()">⚡ Let's go!</button>
                </div>
            </div>
        </div>

        

        <!-- Firebase SDK (v9 with compat mode) -->
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
            import { getFirestore, doc, setDoc, getDoc, collection, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
            
            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBDVhjiXaw26HhD8TBULTc4dHRDTSb-fI4",
                authDomain: "alexnvtcar-c443c.firebaseapp.com",
                projectId: "alexnvtcar-c443c",
                storageBucket: "alexnvtcar-c443c.firebasestorage.app",
                messagingSenderId: "972197392704",
                appId: "1:972197392704:web:85c308f2c4482890fb8aa5"
            };
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            
            // Initialize Firestore
            const db = getFirestore(app);
            
            // Make available globally
            window.db = db;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.collection = collection;
            window.updateDoc = updateDoc;
            
            // Debug logging
            console.log('🔥 Firebase initialized successfully!');
            console.log('📱 App ID:', firebaseConfig.appId);
            console.log('🌐 Project ID:', firebaseConfig.projectId);
            console.log('💾 Firestore DB:', db);
            console.log('🔧 Available functions:', { doc, setDoc, getDoc, collection, updateDoc });
            
            // Check if Firebase is available globally
            if (window.db && window.doc && window.setDoc && window.getDoc && window.updateDoc) {
                console.log('✅ Firebase functions are globally available');
                window.firebaseReady = true;
            } else {
                console.error('❌ Firebase functions are not properly exposed');
                window.firebaseReady = false;
            }
        </script>
        
        <!-- App Script -->
        <script src="app.js"></script>
    </body>
</html>
